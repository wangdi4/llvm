; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 2
; RUN: opt -S -passes=licm < %s | FileCheck %s

; GEPs should not be reassociated by LICM when DTrans is enabled. This causes
; performance regressions.

%class.test = type { i64, i32 }

declare void @use(ptr)
declare i32 @get.i32()
declare ptr @get.ptr()

; CHECK-LABEL: loop:
; CHECK: getelementptr inbounds i8, ptr %ptr, i64 %val.ext
; CHECK: getelementptr i8, ptr %ptr2, i64 %arg.ext

define void @only_one_inbounds(ptr %ptr, i1 %c, i32 %arg) {
entry:
  %arg.ext = zext i32 %arg to i64
  br label %loop

loop:
  %val = call i32 @get.i32()
  %val.ext = zext i32 %val to i64
  %ptr2 = getelementptr inbounds i8, ptr %ptr, i64 %val.ext
  %ptr3 = getelementptr i8, ptr %ptr2, i64 %arg.ext
  call void @use(ptr %ptr3)
  br i1 %c, label %loop, label %exit

exit:
  ret void
}

!intel.dtrans.types = !{!2}

!0 = !{i64 0, i32 0}
!1 = !{i32 0, i32 0}
!2 = !{!"S", %class.test zeroinitializer, i32 2, !0, !1}
