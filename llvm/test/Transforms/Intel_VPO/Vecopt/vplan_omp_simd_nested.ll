; NOTE: Assertions have been autogenerated by utils/intel_update_vplan_checks.py UTC_ARGS: --version 2
; RUN: opt %s -disable-output -passes=vplan-vec -debug-only=VPlanLegality -vplan-nested-simd-strategy=bailout 2>&1 | FileCheck %s --check-prefix=BAILOUT
; RUN: opt %s -disable-output -passes=vplan-vec -vplan-print-after-vpentity-instrs -vplan-nested-simd-strategy=outermost -vplan-force-vf=4 | FileCheck %s --check-prefix=OUTER
; RUN: opt %s -disable-output -passes=vplan-vec -vplan-print-after-vpentity-instrs -vplan-nested-simd-strategy=innermost -vplan-force-vf=4 | FileCheck %s --check-prefix=INNER
; RUN: opt %s -disable-output -passes=vplan-vec -vplan-print-after-vpentity-instrs -vplan-force-vf=4 | FileCheck %s --check-prefix=OUTER

; RUN: opt %s -disable-output -passes=hir-ssa-deconstruction,hir-temp-cleanup,hir-vplan-vec -debug-only=LoopVectorizationPlanner -vplan-nested-simd-strategy=bailout 2>&1 | FileCheck %s --check-prefix=BAILOUT
; RUN: opt %s -disable-output -passes=hir-ssa-deconstruction,hir-temp-cleanup,hir-vplan-vec -vplan-print-after-vpentity-instrs -vplan-nested-simd-strategy=outermost -vplan-force-vf=4 | FileCheck %s --check-prefix=HIR-OUTER
; RUN: opt %s -disable-output -passes=hir-ssa-deconstruction,hir-temp-cleanup,hir-vplan-vec -vplan-print-after-vpentity-instrs -vplan-nested-simd-strategy=innermost -vplan-force-vf=4 | FileCheck %s --check-prefix=HIR-INNER
; RUN: opt %s -disable-output -passes=hir-ssa-deconstruction,hir-temp-cleanup,hir-vplan-vec -vplan-print-after-vpentity-instrs -vplan-force-vf=4 | FileCheck %s --check-prefix=HIR-OUTER

target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

define internal void @foo(ptr nocapture readonly %a.addr.0.val, ptr noalias nocapture %sum) {
; BAILOUT:      Unsupported nested OpenMP (simd) loop or region.
;
; OUTER-LABEL:  VPlan after insertion of VPEntities instructions:
; OUTER-NEXT:  VPlan IR for: foo:omp.inner.for.body.#{{[0-9]+}}
; OUTER:         [[BB2:BB[0-9]+]]: # preds: [[BB1:BB[0-9]+]], [[BB3:BB[0-9]+]]
; OUTER-NEXT:     i64 [[VP_INDVARS_IV3:%.*]] = phi  [ i64 [[VP_INDVARS_IV3_IND_INIT:%.*]], [[BB1]] ],  [ i64 [[VP_INDVARS_IV_NEXT4:%.*]], [[BB3]] ]
; OUTER-NEXT:     i32 [[VP0:%.*]] = phi  [ i32 [[VP_I_PRIV_IND_INIT:%.*]], [[BB1]] ],  [ i32 [[VP1:%.*]], [[BB3]] ]
; OUTER-NEXT:     store i32 [[VP0]] ptr [[VP_I_PRIV:%.*]]
; OUTER-NEXT:     i32 [[VP_I5:%.*]] = trunc i64 [[VP_INDVARS_IV3]] to i32
; OUTER-NEXT:     store i32 [[VP_I5]] ptr [[VP_I_PRIV]]
; OUTER-NEXT:     br [[BB4:BB[0-9]+]]
;
; OUTER:         [[BB6:BB[0-9]+]]: # preds: [[BB5:BB[0-9]+]], [[BB6]]
; OUTER-NEXT:     i64 [[VP_INDVARS_IV:%.*]] = phi  [ i64 0, [[BB5]] ],  [ i64 [[VP_INDVARS_IV_NEXT:%.*]], [[BB6]] ]
; OUTER-NEXT:     i32 [[VP_ADD222:%.*]] = phi  [ i32 [[VP_SUM_PROMOTED:%.*]], [[BB5]] ],  [ i32 [[VP_ADD22:%.*]], [[BB6]] ]
; OUTER-NEXT:     ptr [[VP_ARRAYIDX21:%.*]] = getelementptr inbounds i32, ptr [[VP_I7:%.*]] i64 [[VP_INDVARS_IV]]
; OUTER-NEXT:     i32 [[VP_I8:%.*]] = load ptr [[VP_ARRAYIDX21]]
; OUTER-NEXT:     i32 [[VP_ADD22]] = add i32 [[VP_ADD222]] i32 [[VP_I8]]
; OUTER-NEXT:     i64 [[VP_INDVARS_IV_NEXT]] = add i64 [[VP_INDVARS_IV]] i64 1
; OUTER-NEXT:     i1 [[VP_EXITCOND_NOT:%.*]] = icmp eq i64 [[VP_INDVARS_IV_NEXT]] i64 1024
; OUTER-NEXT:     br i1 [[VP_EXITCOND_NOT]], [[BB7:BB[0-9]+]], [[BB6]]
;
; OUTER:         [[BB3]]: # preds: [[BB8:BB[0-9]+]]
; OUTER-NEXT:     i64 [[VP_INDVARS_IV_NEXT4]] = add i64 [[VP_INDVARS_IV3]] i64 [[VP_INDVARS_IV3_IND_INIT_STEP:%.*]]
; OUTER-NEXT:     i32 [[VP1]] = add i32 [[VP0]] i32 [[VP_I_PRIV_IND_INIT_STEP:%.*]]
; OUTER-NEXT:     i1 [[VP_EXITCOND6:%.*]] = icmp eq i64 [[VP_INDVARS_IV_NEXT4]] i64 1024
; OUTER-NEXT:     br i1 [[VP_EXITCOND6]], [[BB9:BB[0-9]+]], [[BB2]]
;
; INNER-LABEL:  VPlan after insertion of VPEntities instructions:
; INNER-NEXT:  VPlan IR for: foo:omp.inner.for.body17.#{{[0-9]+}}
; INNER-NEXT:    [[BB0:BB[0-9]+]]: # preds:
; INNER-NEXT:     br [[BB1:BB[0-9]+]]
; INNER-EMPTY:
; INNER-NEXT:    [[BB1]]: # preds: [[BB0]]
; INNER-NEXT:     i32 [[VP_ADD222RED_INIT:%.*]] = reduction-init i32 0 i32 [[SUM_PROMOTED0:%.*]]
; INNER-NEXT:     i64 [[VP_INDVARS_IV_IND_INIT:%.*]] = induction-init{add} i64 0 i64 1
; INNER-NEXT:     i64 [[VP_INDVARS_IV_IND_INIT_STEP:%.*]] = induction-init-step{add} i64 1
; INNER-NEXT:     br [[BB2:BB[0-9]+]]
; INNER-EMPTY:
; INNER-NEXT:    [[BB2]]: # preds: [[BB1]], [[BB2]]
; INNER-NEXT:     i64 [[VP_INDVARS_IV:%.*]] = phi  [ i64 [[VP_INDVARS_IV_IND_INIT]], [[BB1]] ],  [ i64 [[VP_INDVARS_IV_NEXT:%.*]], [[BB2]] ]
; INNER-NEXT:     i32 [[VP_ADD222:%.*]] = phi  [ i32 [[VP_ADD222RED_INIT]], [[BB1]] ],  [ i32 [[VP_ADD22:%.*]], [[BB2]] ]
; INNER-NEXT:     ptr [[VP_ARRAYIDX21:%.*]] = getelementptr inbounds i32, ptr [[I70:%.*]] i64 [[VP_INDVARS_IV]]
; INNER-NEXT:     i32 [[VP_I8:%.*]] = load ptr [[VP_ARRAYIDX21]]
; INNER-NEXT:     i32 [[VP_ADD22]] = add i32 [[VP_ADD222]] i32 [[VP_I8]]
; INNER-NEXT:     i64 [[VP_INDVARS_IV_NEXT]] = add i64 [[VP_INDVARS_IV]] i64 [[VP_INDVARS_IV_IND_INIT_STEP]]
; INNER-NEXT:     i1 [[VP_EXITCOND_NOT:%.*]] = icmp eq i64 [[VP_INDVARS_IV_NEXT]] i64 1024
; INNER-NEXT:     br i1 [[VP_EXITCOND_NOT]], [[BB3:BB[0-9]+]], [[BB2]]
; INNER-EMPTY:
; INNER-NEXT:    [[BB3]]: # preds: [[BB2]]
; INNER-NEXT:     i32 [[VP_ADD222RED_FINAL:%.*]] = reduction-final{u_add} i32 [[VP_ADD22]]
; INNER-NEXT:     i64 [[VP_INDVARS_IV_IND_FINAL:%.*]] = induction-final{add} i64 0 i64 1
; INNER-NEXT:     br [[BB4:BB[0-9]+]]
; INNER-EMPTY:
; INNER-NEXT:    [[BB4]]: # preds: [[BB3]]
; INNER-NEXT:     br <External Block>
; INNER-EMPTY:
; INNER-NEXT:  External Uses:
; INNER-NEXT:  Id: 0     [[ADD22_LCSSA0:%.*]] = phi i32 [ [[ADD220:%.*]], [[OMP_INNER_FOR_BODY170:%.*]] ] i32 [[VP_ADD222RED_FINAL]] -> i32 [[ADD220]]
;
; HIR-OUTER-LABEL:  VPlan after insertion of VPEntities instructions:
; HIR-OUTER-NEXT:  VPlan IR for: foo:HIR.#{{[0-9]+}}
;
; HIR-OUTER:         [[BB2:BB[0-9]+]]: # preds: [[BB1:BB[0-9]+]], [[BB3:BB[0-9]+]]
; HIR-OUTER-NEXT:     i64 [[VP5:%.*]] = phi  [ i64 [[VP__IND_INIT:%.*]], [[BB1]] ],  [ i64 [[VP6:%.*]], [[BB3]] ]
; HIR-OUTER-NEXT:     i32 [[VP7:%.*]] = phi  [ i32 [[VP_I_PRIV_IND_INIT:%.*]], [[BB1]] ],  [ i32 [[VP8:%.*]], [[BB3]] ]
; HIR-OUTER-NEXT:     store i32 [[VP7]] ptr [[VP_I_PRIV:%.*]]
; HIR-OUTER-NEXT:     i32 [[VP9:%.*]] = trunc i64 [[VP5]] to i32
; HIR-OUTER-NEXT:     ptr [[VP_SUBSCRIPT:%.*]] = subscript inbounds ptr [[VP_I_PRIV]]
; HIR-OUTER-NEXT:     store i32 [[VP9]] ptr [[VP_SUBSCRIPT]]
; HIR-OUTER-NEXT:     ptr [[VP_SUBSCRIPT_2:%.*]] = subscript inbounds ptr [[A_ADDR_0_VAL0:%.*]] i64 [[VP5]]
; HIR-OUTER-NEXT:     ptr [[VP_LOAD_1:%.*]] = load ptr [[VP_SUBSCRIPT_2]]
; HIR-OUTER-NEXT:     ptr [[VP_SUBSCRIPT_3:%.*]] = subscript inbounds ptr [[SUM0:%.*]]
; HIR-OUTER-NEXT:     i32 [[VP_LOAD_2:%.*]] = load ptr [[VP_SUBSCRIPT_3]]
; HIR-OUTER-NEXT:     br [[BB4:BB[0-9]+]]
;
; HIR-OUTER:         [[BB5:BB[0-9]+]]: # preds: [[BB4]], [[BB5]]
; HIR-OUTER-NEXT:     i32 [[VP10:%.*]] = phi  [ i32 [[VP_LOAD_2]], [[BB4]] ],  [ i32 [[VP11:%.*]], [[BB5]] ]
; HIR-OUTER-NEXT:     i64 [[VP12:%.*]] = phi  [ i64 0, [[BB4]] ],  [ i64 [[VP13:%.*]], [[BB5]] ]
; HIR-OUTER-NEXT:     ptr [[VP_SUBSCRIPT_4:%.*]] = subscript inbounds ptr [[VP_LOAD_1]] i64 [[VP12]]
; HIR-OUTER-NEXT:     i32 [[VP_LOAD_3:%.*]] = load ptr [[VP_SUBSCRIPT_4]]
; HIR-OUTER-NEXT:     i32 [[VP11]] = add i32 [[VP10]] i32 [[VP_LOAD_3]]
; HIR-OUTER-NEXT:     i64 [[VP13]] = add i64 [[VP12]] i64 1
; HIR-OUTER-NEXT:     i1 [[VP14:%.*]] = icmp slt i64 [[VP13]] i64 1024
; HIR-OUTER-NEXT:     br i1 [[VP14]], [[BB5]], [[BB3]]
; HIR-OUTER-EMPTY:
; HIR-OUTER-NEXT:    [[BB3]]: # preds: [[BB5]]
; HIR-OUTER-NEXT:     ptr [[VP_SUBSCRIPT_5:%.*]] = subscript inbounds ptr [[SUM0]]
; HIR-OUTER-NEXT:     store i32 [[VP11]] ptr [[VP_SUBSCRIPT_5]]
; HIR-OUTER-NEXT:     i64 [[VP6]] = add i64 [[VP5]] i64 [[VP__IND_INIT_STEP:%.*]]
; HIR-OUTER-NEXT:     i32 [[VP8]] = add i32 [[VP7]] i32 [[VP_I_PRIV_IND_INIT_STEP:%.*]]
; HIR-OUTER-NEXT:     i1 [[VP15:%.*]] = icmp slt i64 [[VP6]] i64 1024
; HIR-OUTER-NEXT:     br i1 [[VP15]], [[BB2]], [[BB6:BB[0-9]+]]
;
; HIR-INNER-LABEL:  VPlan after insertion of VPEntities instructions:
; HIR-INNER-NEXT:  VPlan IR for: foo:HIR.#{{[0-9]+}}
; HIR-INNER-NEXT:  External Defs Start:
; HIR-INNER-DAG:     [[VP0:%.*]] = {%add222}
; HIR-INNER-DAG:     [[VP2:%.*]] = {%i7}
; HIR-INNER-NEXT:  External Defs End:
; HIR-INNER-NEXT:    [[BB0:BB[0-9]+]]: # preds:
; HIR-INNER-NEXT:     br [[BB1:BB[0-9]+]]
; HIR-INNER-EMPTY:
; HIR-INNER-NEXT:    [[BB1]]: # preds: [[BB0]]
; HIR-INNER-NEXT:     i32 [[VP_RED_INIT:%.*]] = reduction-init i32 0 i32 [[ADD2220:%.*]]
; HIR-INNER-NEXT:     i64 [[VP__IND_INIT:%.*]] = induction-init{add} i64 0 i64 1
; HIR-INNER-NEXT:     i64 [[VP__IND_INIT_STEP:%.*]] = induction-init-step{add} i64 1
; HIR-INNER-NEXT:     br [[BB2:BB[0-9]+]]
; HIR-INNER-EMPTY:
; HIR-INNER-NEXT:    [[BB2]]: # preds: [[BB1]], [[BB2]]
; HIR-INNER-NEXT:     i32 [[VP3:%.*]] = phi  [ i32 [[VP_RED_INIT]], [[BB1]] ],  [ i32 [[VP4:%.*]], [[BB2]] ]
; HIR-INNER-NEXT:     i64 [[VP5:%.*]] = phi  [ i64 [[VP__IND_INIT]], [[BB1]] ],  [ i64 [[VP6:%.*]], [[BB2]] ]
; HIR-INNER-NEXT:     ptr [[VP_SUBSCRIPT:%.*]] = subscript inbounds ptr [[I70:%.*]] i64 [[VP5]]
; HIR-INNER-NEXT:     i32 [[VP_LOAD:%.*]] = load ptr [[VP_SUBSCRIPT]]
; HIR-INNER-NEXT:     i32 [[VP4]] = add i32 [[VP3]] i32 [[VP_LOAD]]
; HIR-INNER-NEXT:     i64 [[VP6]] = add i64 [[VP5]] i64 [[VP__IND_INIT_STEP]]
; HIR-INNER-NEXT:     i1 [[VP7:%.*]] = icmp slt i64 [[VP6]] i64 1024
; HIR-INNER-NEXT:     br i1 [[VP7]], [[BB2]], [[BB3:BB[0-9]+]]
; HIR-INNER-EMPTY:
; HIR-INNER-NEXT:    [[BB3]]: # preds: [[BB2]]
; HIR-INNER-NEXT:     i32 [[VP_RED_FINAL:%.*]] = reduction-final{u_add} i32 [[VP4]]
; HIR-INNER-NEXT:     i64 [[VP__IND_FINAL:%.*]] = induction-final{add} i64 0 i64 1
; HIR-INNER-NEXT:     br [[BB4:BB[0-9]+]]
; HIR-INNER-EMPTY:
; HIR-INNER-NEXT:    [[BB4]]: # preds: [[BB3]]
; HIR-INNER-NEXT:     br <External Block>
; HIR-INNER-EMPTY:
; HIR-INNER-NEXT:  External Uses:
; HIR-INNER-NEXT:  Id: 0   i32 [[VP_RED_FINAL]] -> [[VP8:%.*]] = {%add222}
;
DIR.OMP.SIMD.4:
  %i.priv = alloca i32, align 4
  br label %DIR.OMP.SIMD.1

DIR.OMP.SIMD.1:                                   ; preds = %DIR.OMP.SIMD.4
  %i2 = call token @llvm.directive.region.entry() [ "DIR.OMP.SIMD"(), "QUAL.OMP.LINEAR:IV.TYPED"(ptr %i.priv, i32 0, i32 1, i32 1) ]
  br label %DIR.OMP.SIMD.115

DIR.OMP.SIMD.115:                                 ; preds = %DIR.OMP.SIMD.1
  br label %omp.inner.for.body

omp.inner.for.body:                               ; preds = %DIR.OMP.SIMD.115, %omp.precond.end
  %indvars.iv3 = phi i64 [ 0, %DIR.OMP.SIMD.115 ], [ %indvars.iv.next4, %omp.precond.end ]
  %i5 = trunc i64 %indvars.iv3 to i32
  store i32 %i5, ptr %i.priv, align 4
  br label %DIR.OMP.SIMD.2

DIR.OMP.SIMD.2:                                   ; preds = %omp.inner.for.body
  %i6 = call token @llvm.directive.region.entry() [ "DIR.OMP.SIMD"() ]
  br label %DIR.OMP.SIMD.117

DIR.OMP.SIMD.117:                                 ; preds = %DIR.OMP.SIMD.2
  %arrayidx = getelementptr inbounds ptr, ptr %a.addr.0.val, i64 %indvars.iv3
  %i7 = load ptr, ptr %arrayidx, align 8
  %sum.promoted = load i32, ptr %sum, align 4
  br label %omp.inner.for.body17

omp.inner.for.body17:                             ; preds = %DIR.OMP.SIMD.117, %omp.inner.for.body17
  %indvars.iv = phi i64 [ 0, %DIR.OMP.SIMD.117 ], [ %indvars.iv.next, %omp.inner.for.body17 ]
  %add222 = phi i32 [ %sum.promoted, %DIR.OMP.SIMD.117 ], [ %add22, %omp.inner.for.body17 ]
  %arrayidx21 = getelementptr inbounds i32, ptr %i7, i64 %indvars.iv
  %i8 = load i32, ptr %arrayidx21, align 4
  %add22 = add nsw i32 %add222, %i8
  %indvars.iv.next = add nuw nsw i64 %indvars.iv, 1
  %exitcond.not = icmp eq i64 %indvars.iv.next, 1024
  br i1 %exitcond.not, label %DIR.OMP.END.SIMD.3, label %omp.inner.for.body17

DIR.OMP.END.SIMD.3:                               ; preds = %omp.inner.for.body17
  %add22.lcssa = phi i32 [ %add22, %omp.inner.for.body17 ]
  store i32 %add22.lcssa, ptr %sum, align 4
  br label %DIR.OMP.END.SIMD.39

DIR.OMP.END.SIMD.39:                              ; preds = %DIR.OMP.END.SIMD.3
  call void @llvm.directive.region.exit(token %i6) [ "DIR.OMP.END.SIMD"() ]
  br label %omp.precond.end

omp.precond.end:                                  ; preds = %DIR.OMP.END.SIMD.39, %omp.inner.for.body
  %indvars.iv.next4 = add nuw nsw i64 %indvars.iv3, 1
  %exitcond6 = icmp eq i64 %indvars.iv.next4, 1024
  br i1 %exitcond6, label %omp.inner.for.cond.DIR.OMP.END.SIMD.9.loopexit_crit_edge, label %omp.inner.for.body

omp.inner.for.cond.DIR.OMP.END.SIMD.9.loopexit_crit_edge: ; preds = %omp.precond.end
  call void @llvm.directive.region.exit(token %i2) [ "DIR.OMP.END.SIMD"() ]
  br label %loop.region.exit

loop.region.exit:                                 ; preds = %DIR.OMP.SIMD.4, %omp.inner.for.cond.DIR.OMP.END.SIMD.9.loopexit_crit_edge
  ret void
}

declare token @llvm.directive.region.entry()
declare void @llvm.directive.region.exit(token)
