; NOTE: Assertions have been autogenerated by utils/intel_update_vplan_checks.py
; RUN: opt -hir-ssa-deconstruction -hir-temp-cleanup -hir-vec-dir-insert -VPlanDriverHIR -disable-output -vplan-print-after-initial-transforms < %s 2>&1 | FileCheck %s

; The test crashed during the loop entities importing. Check that CFG is built and entities are in place.
;
define dso_local i32 @main(i32* %x4, [100 x i32]* %u0, i64 %n) local_unnamed_addr #0 {
; CHECK-LABEL:  VPlan after initial VPlan transforms:
; CHECK:          i32 [[VP__RED_INIT:%.*]] = reduction-init i32 0 i32 live-in1
; CHECK-NEXT:     i64 [[VP__IND_INIT:%.*]] = induction-init{add} i64 live-in2 i64 1
; CHECK-NEXT:     i64 [[VP__IND_INIT_STEP:%.*]] = induction-init-step{add} i64 1
; CHECK-LABEL:  External Uses:
; CHECK:       Id: 1   i32 [[VP__RED_FINAL:%.*]] -> [[VP21:%.*]] = {%x4.sroa.0.140}
;
preheader:
  %x4.sroa.0.044 = load i32, i32* %x4
  br label %header

header:
  %indvars.iv = phi i64 [ 1, %preheader ], [ %indvars.iv.next48, %if.merge ]
  %x4.sroa.0.140 = phi i32 [ %x4.sroa.0.044, %preheader ], [ %x4.sroa.0.2.lcssa, %if.merge ]
  %storemerge3238 = phi i32 [ 1, %preheader ], [ %inc12, %if.merge ]
  %cmp734 = icmp ult i32 %storemerge3238, 2
  %indvars.iv.next48 = add nuw i64 %indvars.iv, 1
  br i1 %cmp734, label %if.then, label %if.merge

if.then:
  %arrayidx9 = getelementptr inbounds [100 x i32], [100 x i32]* %u0, i64 0, i64 %indvars.iv
  %0 = load i32, i32* %arrayidx9, align 4
  %sub10 = sub i32 %x4.sroa.0.140, %0
  %1 = trunc i64 %indvars.iv.next48 to i32
  br label %if.merge

if.merge:
  %inc.lcssa45 = phi i32 [ %1, %if.then ], [ %storemerge3238, %header ]
  %x4.sroa.0.2.lcssa = phi i32 [ %sub10, %if.then ], [ %x4.sroa.0.140, %header ]
  %inc12 = add nuw nsw i32 %storemerge3238, 1
  %exitcond = icmp eq i64 %indvars.iv.next48, %n
  br i1 %exitcond, label %exit, label %header

exit:
  %inc.lcssa45.lcssa = phi i32 [ %inc.lcssa45, %if.merge ]
  %x4.sroa.0.2.lcssa.lcssa = phi i32 [ %x4.sroa.0.2.lcssa, %if.merge ]
  %ret = add i32 %inc.lcssa45.lcssa, %x4.sroa.0.2.lcssa
  ret i32 %ret
}
