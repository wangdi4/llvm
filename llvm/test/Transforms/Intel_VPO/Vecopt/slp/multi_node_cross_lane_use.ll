; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s -S -enable-intel-advanced-opts -slp-vectorizer -mattr=+avx2 | FileCheck %s
target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

; Jira: CMPLRLLVM-33821
define void @main(i32* %arg, i32 %arg1, i32 %arg2) {
; CHECK-LABEL: @main(
; CHECK-NEXT:  bb:
; CHECK-NEXT:    [[T:%.*]] = getelementptr i32, i32* [[ARG:%.*]], i64 1
; CHECK-NEXT:    [[T3:%.*]] = getelementptr i32, i32* [[ARG]], i64 0
; CHECK-NEXT:    [[T4:%.*]] = getelementptr i32, i32* [[ARG]], i64 2
; CHECK-NEXT:    [[T5:%.*]] = getelementptr i32, i32* [[ARG]], i64 3
; CHECK-NEXT:    [[T6:%.*]] = add i32 [[ARG2:%.*]], 42
; CHECK-NEXT:    [[TMP0:%.*]] = insertelement <4 x i32> poison, i32 [[ARG2]], i32 0
; CHECK-NEXT:    [[SHUFFLE:%.*]] = shufflevector <4 x i32> [[TMP0]], <4 x i32> poison, <4 x i32> zeroinitializer
; CHECK-NEXT:    [[TMP1:%.*]] = insertelement <4 x i32> <i32 7, i32 13, i32 13, i32 poison>, i32 [[T6]], i32 3
; CHECK-NEXT:    [[TMP2:%.*]] = add <4 x i32> [[SHUFFLE]], [[TMP1]]
; CHECK-NEXT:    [[TMP3:%.*]] = insertelement <4 x i32> <i32 7, i32 3, i32 poison, i32 9>, i32 [[T6]], i32 2
; CHECK-NEXT:    [[TMP4:%.*]] = add <4 x i32> [[TMP2]], [[TMP3]]
; CHECK-NEXT:    [[TMP5:%.*]] = insertelement <4 x i32> <i32 poison, i32 13, i32 13, i32 13>, i32 [[ARG2]], i32 0
; CHECK-NEXT:    [[TMP6:%.*]] = add <4 x i32> [[TMP5]], [[TMP4]]
; CHECK-NEXT:    [[TMP7:%.*]] = extractelement <4 x i32> [[TMP4]], i32 1
; CHECK-NEXT:    [[TMP8:%.*]] = insertelement <4 x i32> <i32 poison, i32 poison, i32 poison, i32 91>, i32 [[TMP7]], i32 0
; CHECK-NEXT:    [[TMP9:%.*]] = extractelement <4 x i32> [[TMP4]], i32 2
; CHECK-NEXT:    [[TMP10:%.*]] = insertelement <4 x i32> [[TMP8]], i32 [[TMP9]], i32 1
; CHECK-NEXT:    [[TMP11:%.*]] = extractelement <4 x i32> [[TMP4]], i32 3
; CHECK-NEXT:    [[TMP12:%.*]] = insertelement <4 x i32> [[TMP10]], i32 [[TMP11]], i32 2
; CHECK-NEXT:    [[TMP13:%.*]] = add <4 x i32> [[TMP6]], [[TMP12]]
; CHECK-NEXT:    [[TMP14:%.*]] = bitcast i32* [[T3]] to <4 x i32>*
; CHECK-NEXT:    store <4 x i32> [[TMP13]], <4 x i32>* [[TMP14]], align 16
; CHECK-NEXT:    ret void
;
bb:
; Lane3:
;         %arg2   42
;          |  \   |
;          |   tmp6
;          |   /
;          tmp13   9
;             \   /
;       13   tmp14
;        \  /
;         tmp21  91
;          |    /
;          tmp22
; MultiNode tried to introduce 91 <->tmp6 reorder which is invalid, because
; tmp13/tmp14 are used in other lanes.
  %t = getelementptr i32, i32* %arg, i64 1
  %t3 = getelementptr i32, i32* %arg, i64 0
  %t4 = getelementptr i32, i32* %arg, i64 2
  %t5 = getelementptr i32, i32* %arg, i64 3
  %t6 = add i32 %arg2, 42
  %t7 = add i32 %arg2, 7
  %t8 = add i32 %t7, 7
  %t9 = add i32 %arg2, 13
  %t10 = add i32 %t9, 3
  %t11 = add i32 %arg2, 13
  %t12 = add i32 %t11, %t6
  %t13 = add i32 %arg2, %t6
  %t14 = add i32 %t13, 9
  %t15 = add i32 %arg2, %t8
  %t16 = add i32 %t15, %t10
  %t17 = add i32 13, %t10
  %t18 = add i32 %t17, %t12
  %t19 = add i32 13, %t12
  %t20 = add i32 %t19, %t14
  %t21 = add i32 13, %t14
  %t22 = add i32 %t21, 91
  store i32 %t16, i32* %t3, align 16
  store i32 %t18, i32* %t, align 4
  store i32 %t20, i32* %t4, align 8
  store i32 %t22, i32* %t5, align 4
  ret void
}
