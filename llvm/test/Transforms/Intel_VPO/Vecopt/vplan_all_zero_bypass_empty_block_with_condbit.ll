; NOTE: Assertions have been autogenerated by utils/intel_update_vplan_checks.py
; REQUIRES: asserts
; RUN: opt < %s -passes="vplan-func-vec" -enable-vplan-func-vec-all-zero-bypass-non-loops -print-after-vplan-func-vec-all-zero-bypass -disable-output -S 2>&1 | FileCheck %s

declare i32 @llvm.vplan.laneid()

; Function Attrs: nounwind uwtable
define dso_local void @foo(ptr nocapture readonly %a, i32 %n) local_unnamed_addr #0 {
; CHECK-LABEL:  VPlan after all-zero bypass for VPlan Function vectorization:
; CHECK-NEXT:  VPlan IR for: foo
; CHECK-NEXT:    [[BB0:BB[0-9]+]]: # preds:
; CHECK-NEXT:     [DA: Div] i32 [[VP_LANE:%.*]] = induction-init{add} i32 0 i32 1
; CHECK-NEXT:     [DA: Uni] i1 [[VP_CMP4:%.*]] = icmp slt i32 [[N0:%.*]] i32 7
; CHECK-NEXT:     [DA: Div] ptr [[VP_ARRAYIDX:%.*]] = getelementptr inbounds i32, ptr [[A0:%.*]] i32 [[VP_LANE]]
; CHECK-NEXT:     [DA: Div] i32 [[VP0:%.*]] = load ptr [[VP_ARRAYIDX]]
; CHECK-NEXT:     [DA: Uni] br [[BB1:BB[0-9]+]]
; CHECK-EMPTY:
; CHECK-NEXT:    [[BB1]]: # preds: [[BB0]]
; CHECK-NEXT:     [DA: Div] i1 [[VP_CMP1:%.*]] = icmp eq i32 [[VP0]] i32 3
; CHECK-NEXT:     [DA: Uni] br all.zero.bypass.begin9
; CHECK-EMPTY:
; CHECK-NEXT:    all.zero.bypass.begin9: # preds: [[BB1]]
; CHECK-NEXT:     [DA: Uni] i1 [[VP_ALL_ZERO_CHECK:%.*]] = all-zero-check i1 [[VP_CMP1]]
; CHECK-NEXT:     [DA: Uni] br i1 [[VP_ALL_ZERO_CHECK]], all.zero.bypass.end11, [[BB2:BB[0-9]+]]
; CHECK-EMPTY:
; CHECK-NEXT:      [[BB2]]: # preds: all.zero.bypass.begin9
; CHECK-NEXT:       [DA: Div] i1 [[VP1:%.*]] = block-predicate i1 [[VP_CMP1]]
; CHECK-NEXT:       [DA: Div] i32 [[VP_X:%.*]] = add i32 [[VP_LANE]] i32 42
; CHECK-NEXT:       [DA: Uni] br all.zero.bypass.end11
; CHECK-EMPTY:
; CHECK-NEXT:    all.zero.bypass.end11: # preds: [[BB2]], all.zero.bypass.begin9
; CHECK-NEXT:     [DA: Uni] br [[BB3:BB[0-9]+]]
; CHECK-EMPTY:
; CHECK-NEXT:    [[BB3]]: # preds: all.zero.bypass.end11
; CHECK-NEXT:     [DA: Uni] br i1 [[VP_CMP4]], [[BB4:BB[0-9]+]], [[BB5:BB[0-9]+]]
; CHECK-EMPTY:
; CHECK-NEXT:      [[BB4]]: # preds: [[BB3]]
; CHECK-NEXT:       [DA: Uni] br [[BB5]]
; CHECK-EMPTY:
; CHECK-NEXT:    [[BB5]]: # preds: [[BB3]], [[BB4]]
; CHECK-NEXT:     [DA: Uni] br [[BB6:BB[0-9]+]]
; CHECK-EMPTY:
; CHECK-NEXT:    [[BB6]]: # preds: [[BB5]]
; CHECK-NEXT:     [DA: Div] ret
; CHECK-NEXT:     [DA: Uni] br <External Block>
;
;        entry
;          |
;        div.if (D)
;       /     |
; div.if.then |
;       \     |
;        uni.if (U)
;       /      |
;  uni.if.then |
;       \      |
;      uni.if.end
;           |
;         exit
;
entry:
  %lane = call i32 @llvm.vplan.laneid()
  %cmp4 = icmp slt i32 %n, 7
  %arrayidx = getelementptr inbounds i32, ptr %a, i32 %lane
  %0 = load i32, ptr %arrayidx, align 4
  br label %div.if

div.if:
  %cmp1 = icmp eq i32 %0, 3
  br i1 %cmp1, label %div.if.then, label %uni.if

div.if.then:
  %x = add i32 %lane, 42
  br label %uni.if

uni.if:
  br i1 %cmp4, label %uni.if.then, label %uni.if.end

uni.if.then:
  br label %uni.if.end

uni.if.end:
  br label %exit

exit:
  ret void
}
