; INTEL_FEATURE_SW_ADVANCED
; REQUIRES: intel_feature_sw_advanced
; NOTE: Assertions have been autogenerated by utils/intel_update_vplan_checks.py
; RUN: opt -enable-new-pm=0 -enable-intel-advanced-opts -hir-ssa-deconstruction -hir-framework -hir-temp-cleanup -hir-vec-dir-insert -hir-vplan-vec -print-after=hir-vplan-vec -disable-output < %s 2>&1 | FileCheck %s
; RUN: opt -passes='hir-ssa-deconstruction,hir-temp-cleanup,hir-vec-dir-insert,hir-vplan-vec,print<hir>' -enable-intel-advanced-opts -disable-output < %s 2>&1 | FileCheck %s

target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

%struct.widget = type { %struct.baz, %struct.baz }
%struct.baz = type { float, float, float, float }

; The test used to crash in VPlan HIR CG.
define void @snork(%struct.widget* %arg) #0 align 2 {
; CHECK:             + DO i1 = 0, 1043, 4   <DO_LOOP> <auto-vectorized> <novectorize>
; CHECK-NEXT:        |   [[EXTRACT_0_0:%.*]] = extractelement &((<4 x <2 x float>*>)([[ARG0:%.*]])[i1 + <i64 0, i64 1, i64 2, i64 3> + 1].1),  0
; CHECK-NEXT:        |   [[GEP_BASE0:%.*]] = [[EXTRACT_0_0]]
; CHECK-NEXT:        |   [[DOTVLS_LOAD0:%.*]] = (<16 x i64>*)([[GEP_BASE0]])[-2]
; CHECK-NEXT:        |   [[VLS_EXTRACT0:%.*]] = shufflevector [[DOTVLS_LOAD0]],  [[DOTVLS_LOAD0]],  <i32 0, i32 4, i32 8, i32 12>
; CHECK-NEXT:        |   [[DOTVEC0:%.*]] = bitcast.<4 x i64>.<8 x float>([[VLS_EXTRACT0]])
; CHECK-NEXT:        |   [[VLS_EXTRACT10:%.*]] = shufflevector [[DOTVLS_LOAD0]],  [[DOTVLS_LOAD0]],  <i32 1, i32 5, i32 9, i32 13>
; CHECK-NEXT:        |   [[DOTVEC20:%.*]] = bitcast.<4 x i64>.<8 x float>([[VLS_EXTRACT10]])
; CHECK-NEXT:        |   [[VLS_EXTRACT30:%.*]] = shufflevector [[DOTVLS_LOAD0]],  [[DOTVLS_LOAD0]],  <i32 2, i32 6, i32 10, i32 14>
; CHECK-NEXT:        |   [[DOTVEC40:%.*]] = bitcast.<4 x i64>.<8 x float>([[VLS_EXTRACT30]])
; CHECK-NEXT:        |   [[VLS_EXTRACT50:%.*]] = shufflevector [[DOTVLS_LOAD0]],  [[DOTVLS_LOAD0]],  <i32 3, i32 7, i32 11, i32 15>
; CHECK-NEXT:        |   [[DOTVEC60:%.*]] = bitcast.<4 x i64>.<8 x float>([[VLS_EXTRACT50]])
; CHECK-NEXT:        |   [[WIDE_EXTRACT0:%.*]] = shufflevector [[DOTVEC40]],  undef,  <i32 0, i32 2, i32 4, i32 6>
; CHECK-NEXT:        |   [[WIDE_EXTRACT70:%.*]] = shufflevector [[DOTVEC0]],  undef,  <i32 1, i32 3, i32 5, i32 7>
; CHECK-NEXT:        |   [[WIDE_EXTRACT80:%.*]] = shufflevector [[DOTVEC60]],  undef,  <i32 0, i32 2, i32 4, i32 6>
; CHECK-NEXT:        |   [[WIDE_EXTRACT90:%.*]] = shufflevector [[DOTVEC20]],  undef,  <i32 0, i32 2, i32 4, i32 6>
; CHECK-NEXT:        + END LOOP
;
bb:
  br label %bb1

bb1:                                              ; preds = %bb1, %bb
  %t = phi i64 [ %t18, %bb1 ], [ 1, %bb ]
  %t2 = getelementptr inbounds %struct.widget, %struct.widget* %arg, i64 %t
  %t3 = bitcast %struct.widget* %t2 to <2 x float>*
  %t4 = getelementptr inbounds %struct.widget, %struct.widget* %arg, i64 %t, i32 0, i32 2
  %t5 = bitcast float* %t4 to <2 x float>*
  %t6 = getelementptr inbounds %struct.widget, %struct.widget* %arg, i64 %t, i32 1
  %t7 = bitcast %struct.baz* %t6 to <2 x float>*
  %t8 = getelementptr inbounds %struct.widget, %struct.widget* %arg, i64 %t, i32 1, i32 2
  %t9 = bitcast float* %t8 to <2 x float>*

  %t12 = load <2 x float>, <2 x float>* %t3, align 16
  %t13 = load <2 x float>, <2 x float>* %t5, align 8
  %t10 = load <2 x float>, <2 x float>* %t7, align 16
  %t11 = load <2 x float>, <2 x float>* %t9, align 8

  %t14 = extractelement <2 x float> %t10, i64 0
  %t15 = extractelement <2 x float> %t12, i64 1
  %t16 = extractelement <2 x float> %t11, i64 0
  %t17 = extractelement <2 x float> %t13, i64 0
  %t18 = add nuw nsw i64 %t, 1
  %t19 = icmp ult i64 %t18, 1048
  br i1 %t19, label %bb1, label %bb20

bb20:                                             ; preds = %bb1
  ret void
}

attributes #0 = { "target-cpu"="skylake" }
; end INTEL_FEATURE_SW_ADVANCED
