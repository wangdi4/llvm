; NOTE: Assertions have been autogenerated by utils/intel_update_vplan_checks.py
; RUN: opt -S -passes="vplan-vec" -vpo-vplan-build-stress-test -vplan-dump-da < %s --disable-output 2>&1 | FileCheck %s
; REQUIRES: asserts

; This is a stress test, we don't really support while-loops. The main issue is
; that VPEntity framework doesn't work on the input, while DA relies on it.
; XFAIL: *

define dso_local void @test1(ptr %a) {
entry:
  br label %simd.begin

simd.begin:
  %tok = call token @llvm.directive.region.entry() [ "DIR.OMP.SIMD"() ]
  br label %preheader

preheader:
  %0 = load i32, ptr %a, align 4
  %idxprom25 = sext i32 %0 to i64
  br label %header

;; %ld is divergent and its divergence makes inner loop backedge divergent too.
;; That means that different lanes [for outer loops] might have different trip
;; counts for the inner loops making any inner IV divergent too.

header:
  %iv = phi i32 [ %iv.next, %latch ], [ 0, %preheader ]
  ; CHECK:  Divergent: [Shape: Random] i32 [[VP_IV:%.*]] = phi  [ i32 [[VP_IV_NEXT:%.*]], [[BB3:BB[0-9]+]] ],  [ i32 0, [[BB4:BB[0-9]+]] ]
  br label %exiting1

exiting1:
  %gep = getelementptr inbounds i32, ptr %a, i32 %iv
  ; CHECK:  Divergent: [Shape: Random] ptr [[VP_GEP:%.*]] = getelementptr inbounds ptr [[A0:%.*]] i32 [[VP_IV]]
  %ld = load i32, ptr %gep, align 8
  ; CHECK:  Divergent: [Shape: Random] i32 [[VP_LD:%.*]] = load ptr [[VP_GEP]]
  %cmp1 = icmp ne i32 %ld, 3
  ; CHECK:  Divergent: [Shape: Random] i1 [[VP_CMP1:%.*]] = icmp i32 [[VP_LD]] i32 3
  br i1 %cmp1, label %exiting2, label %loop.exit

exiting2:
  %cmp2 = icmp slt i32 %iv, 42
  ; CHECK:  Divergent: [Shape: Random] i1 [[VP_CMP2:%.*]] = icmp i32 [[VP_IV]] i32 42
  br i1 %cmp2, label %latch, label %loop.exit

latch:
  %iv.next = add i32 %iv, 1
  ; CHECK:  Divergent: [Shape: Random] i32 [[VP_IV_NEXT]] = add i32 [[VP_IV]] i32 1
  br label %header

loop.exit:
  br label %simd.end

simd.end:
  call void @llvm.directive.region.exit(token %tok) [ "DIR.OMP.END.SIMD"()]
  br label %exit

exit:
  ret void
}

declare token @llvm.directive.region.entry()
declare void @llvm.directive.region.exit(token)
