; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --function-signature
; INTEL_CUSTOMIZATION
; RUN: opt -passes=argpromotion -S %s | FileCheck %s
; NOTE: INTEL_CUSTOMIZATIONs due to our desire to retain a value of 
; MaxElements=3 after Nikita Popov's rewrite of argument promotion (offset
; based argument promotion) on 20220128. 
; end INTEL_CUSTOMIZATION
define internal i32 @callee2(ptr noundef %0) {
; CHECK-LABEL: define {{[^@]+}}@callee2
; CHECK-SAME: (i32 [[DOT0_VAL:%.*]], i32 [[DOT4_VAL:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = add nsw i32 [[DOT0_VAL]], [[DOT4_VAL]]
; CHECK-NEXT:    ret i32 [[TMP1]]
;
  %2 = load i32, ptr %0, align 4
  %3 = getelementptr inbounds i32, ptr %0, i64 1
  %4 = load i32, ptr %3, align 4
  %5 = add nsw i32 %2, %4
  ret i32 %5
}

define i32 @caller2(i32 %0, i32 %1) {
; CHECK-LABEL: define {{[^@]+}}@caller2
; CHECK-SAME: (i32 [[TMP0:%.*]], i32 [[TMP1:%.*]]) {
; CHECK-NEXT:    [[TMP3:%.*]] = alloca [2 x i32], align 4
; CHECK-NEXT:    store i32 [[TMP0]], ptr [[TMP3]], align 4
; CHECK-NEXT:    [[TMP4:%.*]] = getelementptr inbounds i32, ptr [[TMP3]], i64 1
; CHECK-NEXT:    store i32 [[TMP1]], ptr [[TMP4]], align 4
; CHECK-NEXT:    [[DOTVAL:%.*]] = load i32, ptr [[TMP3]], align 4
; CHECK-NEXT:    [[TMP5:%.*]] = getelementptr i8, ptr [[TMP3]], i64 4
; CHECK-NEXT:    [[DOTVAL1:%.*]] = load i32, ptr [[TMP5]], align 4
; CHECK-NEXT:    [[TMP6:%.*]] = call i32 @callee2(i32 [[DOTVAL]], i32 [[DOTVAL1]])
; CHECK-NEXT:    ret i32 [[TMP6]]
;
  %3 = alloca [2 x i32], align 4
  store i32 %0, ptr %3, align 4
  %4 = getelementptr inbounds i32, ptr %3, i64 1
  store i32 %1, ptr %4, align 4
  %5 = call i32 @callee2(ptr noundef %3)
  ret i32 %5
}

; INTEL_CUSTOMIZATION
; Since MaxElements=3, use a test case with 4 to illustrate that no transform
; occurs when transformation to 4 arguments would be needed.
define internal i32 @callee4(ptr noundef %0) {
; CHECK-LABEL: define {{[^@]+}}@callee4
; end INTEL_CUSTOMIZATION
; CHECK-SAME: (ptr noundef [[TMP0:%.*]]) {
; CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[TMP0]], align 4
; CHECK-NEXT:    [[TMP3:%.*]] = getelementptr inbounds i32, ptr [[TMP0]], i64 1
; CHECK-NEXT:    [[TMP4:%.*]] = load i32, ptr [[TMP3]], align 4
; CHECK-NEXT:    [[TMP5:%.*]] = add nsw i32 [[TMP2]], [[TMP4]]
; CHECK-NEXT:    [[TMP6:%.*]] = getelementptr inbounds i32, ptr [[TMP0]], i64 2
; CHECK-NEXT:    [[TMP7:%.*]] = load i32, ptr [[TMP6]], align 4
; INTEL_CUSTOMIZATION
; CHECK-NEXT:    [[TMP8:%.*]] = add nsw i32 [[TMP5]], [[TMP7]]
; CHECK-NEXT:    [[TMP9:%.*]] = getelementptr inbounds i32, ptr [[TMP0]], i64 3
; CHECK-NEXT:    [[TMP10:%.*]] = load i32, ptr [[TMP9]], align 4
; CHECK-NEXT:    [[TMP11:%.*]] = add nsw i32 [[TMP8]], [[TMP10]]
; CHECK-NEXT:    ret i32 [[TMP11]]
; end INTEL_CUSTOMIZATION
;
  %2 = load i32, ptr %0, align 4
  %3 = getelementptr inbounds i32, ptr %0, i64 1
  %4 = load i32, ptr %3, align 4
  %5 = add nsw i32 %2, %4
  %6 = getelementptr inbounds i32, ptr %0, i64 2
  %7 = load i32, ptr %6, align 4
  %8 = add nsw i32 %5, %7
; INTEL_CUSTOMIZATION
  %9 = getelementptr inbounds i32, ptr %0, i64 3
  %10 = load i32, ptr %9, align 4
  %11 = add nsw i32 %8, %10
  ret i32 %11
; end INTEL_CUSTOMIZATION
}

; INTEL_CUSTOMIZATION
define i32 @caller4(i32 %0, i32 %1, i32 %2, i32 %3) {
; CHECK-LABEL: define {{[^@]+}}@caller4
; CHECK-SAME: (i32 [[TMP0:%.*]], i32 [[TMP1:%.*]], i32 [[TMP2:%.*]], i32 [[TMP3:%.*]]) {
; CHECK-NEXT:    [[TMP5:%.*]] = alloca [4 x i32], align 4
; CHECK-NEXT:    store i32 [[TMP0]], ptr [[TMP5]], align 4
; CHECK-NEXT:    [[TMP6:%.*]] = getelementptr inbounds i32, ptr [[TMP5]], i64 1
; CHECK-NEXT:    store i32 [[TMP1]], ptr [[TMP6]], align 4
; CHECK-NEXT:    [[TMP7:%.*]] = getelementptr inbounds i32, ptr [[TMP6]], i64 1
; CHECK-NEXT:    store i32 [[TMP2]], ptr [[TMP7]], align 4
; CHECK-NEXT:    [[TMP8:%.*]] = getelementptr inbounds i32, ptr [[TMP7]], i64 1
; CHECK-NEXT:    store i32 [[TMP3]], ptr [[TMP8]], align 4
; CHECK-NEXT:    [[TMP9:%.*]] = call i32 @callee4(ptr noundef [[TMP5]])
; CHECK-NEXT:    ret i32 [[TMP9]]
;
  %5 = alloca [4 x i32], align 4
  store i32 %0, ptr %5, align 4
  %6 = getelementptr inbounds i32, ptr %5, i64 1
  store i32 %1, ptr %6, align 4
  %7 = getelementptr inbounds i32, ptr %6, i64 1
  store i32 %2, ptr %7, align 4
  %8 = getelementptr inbounds i32, ptr %7, i64 1
  store i32 %3, ptr %8, align 4
  %9 = call i32 @callee4(ptr noundef %5)
  ret i32 %9
; end INTEL_CUSTOMIZATION
}
