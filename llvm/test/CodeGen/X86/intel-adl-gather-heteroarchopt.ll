; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mcpu=alderlake -enable-intel-advanced-opts -O3 | FileCheck %s
target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

; Function Attrs: nofree norecurse nosync nounwind readonly uwtable
define dso_local double @foo(double* noalias nocapture readonly %dst, double* noalias nocapture readonly %luval, i32** nocapture readonly %rowstart, i32* nocapture readnone %first_after_diagonal, i32 %N) local_unnamed_addr #0 {
; CHECK-LABEL: foo:
; CHECK:       # %bb.0: # %entry.new
; CHECK-NEXT:    movq %rdx, %r9
; CHECK-NEXT:    movl $2, %eax
; CHECK-NEXT:    #APP
; CHECK-NEXT:    xchgq %rbx, %r10
; CHECK-NEXT:    cpuid
; CHECK-NEXT:    xchgq %rbx, %r10
; CHECK-NEXT:    #NO_APP
; CHECK-NEXT:    testl %r10d, %r10d
; CHECK-NEXT:    je .LBB0_7
; CHECK-NEXT:  # %bb.1: # %entry
; CHECK-NEXT:    testl %r8d, %r8d
; CHECK-NEXT:    jle .LBB0_14
; CHECK-NEXT:  # %bb.2: # %for.body.preheader
; CHECK-NEXT:    movl %r8d, %r10d
; CHECK-NEXT:    decq %r10
; CHECK-NEXT:    vxorpd %xmm0, %xmm0, %xmm0
; CHECK-NEXT:    xorl %r11d, %r11d
; CHECK-NEXT:    .p2align 4, 0x90
; CHECK-NEXT:  .LBB0_3: # %loop.39
; CHECK-NEXT:    # =>This Loop Header: Depth=1
; CHECK-NEXT:    # Child Loop BB0_4 Depth 2
; CHECK-NEXT:    movl %r11d, %eax
; CHECK-NEXT:    notl %eax
; CHECK-NEXT:    addl %r8d, %eax
; CHECK-NEXT:    movq (%r9,%rax,8), %rdx
; CHECK-NEXT:    xorl %eax, %eax
; CHECK-NEXT:    vxorpd %xmm1, %xmm1, %xmm1
; CHECK-NEXT:    vxorpd %xmm2, %xmm2, %xmm2
; CHECK-NEXT:    vxorpd %xmm3, %xmm3, %xmm3
; CHECK-NEXT:    vxorpd %xmm4, %xmm4, %xmm4
; CHECK-NEXT:    .p2align 4, 0x90
; CHECK-NEXT:  .LBB0_4: # %loop.48
; CHECK-NEXT:    # Parent Loop BB0_3 Depth=1
; CHECK-NEXT:    # => This Inner Loop Header: Depth=2
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm5 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm6 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpcmpeqd %ymm7, %ymm7, %ymm7
; CHECK-NEXT:    vxorpd %xmm8, %xmm8, %xmm8
; CHECK-NEXT:    vgatherqpd %ymm7, (%rdi,%ymm6,8), %ymm8
; CHECK-NEXT:    vpcmpeqd %ymm6, %ymm6, %ymm6
; CHECK-NEXT:    vxorpd %xmm7, %xmm7, %xmm7
; CHECK-NEXT:    vgatherqpd %ymm6, (%rdi,%ymm5,8), %ymm7
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm5 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm6 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpcmpeqd %ymm9, %ymm9, %ymm9
; CHECK-NEXT:    vxorpd %xmm10, %xmm10, %xmm10
; CHECK-NEXT:    vgatherqpd %ymm9, (%rdi,%ymm6,8), %ymm10
; CHECK-NEXT:    vpcmpeqd %ymm6, %ymm6, %ymm6
; CHECK-NEXT:    vxorpd %xmm9, %xmm9, %xmm9
; CHECK-NEXT:    vgatherqpd %ymm6, (%rdi,%ymm5,8), %ymm9
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm3 = (ymm9 * mem) + ymm3
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm2 = (ymm10 * mem) + ymm2
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm1 = (ymm7 * mem) + ymm1
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm4 = (ymm8 * mem) + ymm4
; CHECK-NEXT:    addq $16, %rax
; CHECK-NEXT:    leal -16(%rax), %ecx
; CHECK-NEXT:    cmpl $4080, %ecx # imm = 0xFF0
; CHECK-NEXT:    jb .LBB0_4
; CHECK-NEXT:  # %bb.5: # %afterloop.48
; CHECK-NEXT:    # in Loop: Header=BB0_3 Depth=1
; CHECK-NEXT:    vaddpd %ymm3, %ymm1, %ymm1
; CHECK-NEXT:    vaddpd %ymm4, %ymm2, %ymm2
; CHECK-NEXT:    vaddpd %ymm2, %ymm1, %ymm1
; CHECK-NEXT:    vextractf128 $1, %ymm1, %xmm2
; CHECK-NEXT:    vaddpd %xmm2, %xmm1, %xmm1
; CHECK-NEXT:    vpermilpd {{.*#+}} xmm2 = xmm1[1,0]
; CHECK-NEXT:    vaddsd %xmm2, %xmm1, %xmm1
; CHECK-NEXT:    vaddsd %xmm1, %xmm0, %xmm0
; CHECK-NEXT:    addq $32768, %rsi # imm = 0x8000
; CHECK-NEXT:    cmpq %r10, %r11
; CHECK-NEXT:    leaq 1(%r11), %r11
; CHECK-NEXT:    jne .LBB0_3
; CHECK-NEXT:  # %bb.6: # %for.cond.cleanup
; CHECK-NEXT:    vzeroupper
; CHECK-NEXT:    retq
; CHECK-NEXT:  .LBB0_7: # %entry.clone
; CHECK-NEXT:    testl %r8d, %r8d
; CHECK-NEXT:    jle .LBB0_14
; CHECK-NEXT:  # %bb.8: # %for.body.preheader.clone
; CHECK-NEXT:    movl %r8d, %r10d
; CHECK-NEXT:    decq %r10
; CHECK-NEXT:    vxorpd %xmm0, %xmm0, %xmm0
; CHECK-NEXT:    xorl %r11d, %r11d
; CHECK-NEXT:    vmovq %rdi, %xmm1
; CHECK-NEXT:    vpbroadcastq %xmm1, %ymm10
; CHECK-NEXT:    .p2align 4, 0x90
; CHECK-NEXT:  .LBB0_9: # %loop.39.clone
; CHECK-NEXT:    # =>This Loop Header: Depth=1
; CHECK-NEXT:    # Child Loop BB0_10 Depth 2
; CHECK-NEXT:    movl %r11d, %edx
; CHECK-NEXT:    notl %edx
; CHECK-NEXT:    addl %r8d, %edx
; CHECK-NEXT:    movq (%r9,%rdx,8), %rdx
; CHECK-NEXT:    vxorpd %xmm11, %xmm11, %xmm11
; CHECK-NEXT:    xorl %edi, %edi
; CHECK-NEXT:    vxorpd %xmm14, %xmm14, %xmm14
; CHECK-NEXT:    vxorpd %xmm4, %xmm4, %xmm4
; CHECK-NEXT:    vxorpd %xmm5, %xmm5, %xmm5
; CHECK-NEXT:    .p2align 4, 0x90
; CHECK-NEXT:  .LBB0_10: # %loop.48.clone
; CHECK-NEXT:    # Parent Loop BB0_9 Depth=1
; CHECK-NEXT:    # => This Inner Loop Header: Depth=2
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm7 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm9 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm8 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpmovzxdq {{.*#+}} ymm6 = mem[0],zero,mem[1],zero,mem[2],zero,mem[3],zero
; CHECK-NEXT:    vpsllq $3, %ymm6, %ymm6
; CHECK-NEXT:    vpaddq %ymm6, %ymm10, %ymm6
; CHECK-NEXT:    vpsllq $3, %ymm8, %ymm8
; CHECK-NEXT:    vpaddq %ymm8, %ymm10, %ymm8
; CHECK-NEXT:    vpsllq $3, %ymm9, %ymm9
; CHECK-NEXT:    vpaddq %ymm9, %ymm10, %ymm9
; CHECK-NEXT:    vpsllq $3, %ymm7, %ymm7
; CHECK-NEXT:    vpaddq %ymm7, %ymm10, %ymm7
; CHECK-NEXT:    vextracti128 $1, %ymm7, %xmm1
; CHECK-NEXT:    vmovq %xmm1, %rax
; CHECK-NEXT:    vpextrq $1, %xmm1, %rcx
; CHECK-NEXT:    vmovsd {{.*#+}} xmm1 = mem[0],zero
; CHECK-NEXT:    vmovq %xmm9, %rax
; CHECK-NEXT:    vextracti128 $1, %ymm9, %xmm2
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm12 = xmm1[0],mem[0]
; CHECK-NEXT:    vmovq %xmm2, %rcx
; CHECK-NEXT:    vmovsd {{.*#+}} xmm1 = mem[0],zero
; CHECK-NEXT:    vpextrq $1, %xmm2, %rcx
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm13 = xmm1[0],mem[0]
; CHECK-NEXT:    vpextrq $1, %xmm9, %rcx
; CHECK-NEXT:    vextracti128 $1, %ymm8, %xmm2
; CHECK-NEXT:    vmovsd {{.*#+}} xmm1 = mem[0],zero
; CHECK-NEXT:    vmovq %xmm2, %rax
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm9 = xmm1[0],mem[0]
; CHECK-NEXT:    vpextrq $1, %xmm2, %rcx
; CHECK-NEXT:    vmovsd {{.*#+}} xmm2 = mem[0],zero
; CHECK-NEXT:    vmovq %xmm8, %rax
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm2 = xmm2[0],mem[0]
; CHECK-NEXT:    vpextrq $1, %xmm8, %rcx
; CHECK-NEXT:    vextracti128 $1, %ymm6, %xmm3
; CHECK-NEXT:    vmovsd {{.*#+}} xmm1 = mem[0],zero
; CHECK-NEXT:    vmovq %xmm3, %rax
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm1 = xmm1[0],mem[0]
; CHECK-NEXT:    vpextrq $1, %xmm3, %rcx
; CHECK-NEXT:    vmovsd {{.*#+}} xmm3 = mem[0],zero
; CHECK-NEXT:    vmovq %xmm6, %rax
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm3 = xmm3[0],mem[0]
; CHECK-NEXT:    vpextrq $1, %xmm6, %rcx
; CHECK-NEXT:    vmovsd {{.*#+}} xmm6 = mem[0],zero
; CHECK-NEXT:    vmovq %xmm7, %rax
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm6 = xmm6[0],mem[0]
; CHECK-NEXT:    vpextrq $1, %xmm7, %rcx
; CHECK-NEXT:    vmovsd {{.*#+}} xmm7 = mem[0],zero
; CHECK-NEXT:    vinsertf128 $1, %xmm13, %ymm9, %ymm8
; CHECK-NEXT:    vinsertf128 $1, %xmm2, %ymm1, %ymm1
; CHECK-NEXT:    vinsertf128 $1, %xmm3, %ymm6, %ymm2
; CHECK-NEXT:    vmovhpd {{.*#+}} xmm3 = xmm7[0],mem[0]
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm5 = (ymm2 * mem) + ymm5
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm4 = (ymm1 * mem) + ymm4
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm14 = (ymm8 * mem) + ymm14
; CHECK-NEXT:    vinsertf128 $1, %xmm12, %ymm3, %ymm1
; CHECK-NEXT:    vfmadd231pd {{.*#+}} ymm11 = (ymm1 * mem) + ymm11
; CHECK-NEXT:    addq $16, %rdi
; CHECK-NEXT:    leal -16(%rdi), %eax
; CHECK-NEXT:    cmpl $4080, %eax # imm = 0xFF0
; CHECK-NEXT:    jb .LBB0_10
; CHECK-NEXT:  # %bb.11: # %afterloop.48.clone
; CHECK-NEXT:    # in Loop: Header=BB0_9 Depth=1
; CHECK-NEXT:    vaddpd %ymm4, %ymm11, %ymm1
; CHECK-NEXT:    vaddpd %ymm5, %ymm14, %ymm2
; CHECK-NEXT:    vaddpd %ymm2, %ymm1, %ymm1
; CHECK-NEXT:    vextractf128 $1, %ymm1, %xmm2
; CHECK-NEXT:    vaddpd %xmm2, %xmm1, %xmm1
; CHECK-NEXT:    vpermilpd {{.*#+}} xmm2 = xmm1[1,0]
; CHECK-NEXT:    vaddsd %xmm2, %xmm1, %xmm1
; CHECK-NEXT:    vaddsd %xmm1, %xmm0, %xmm0
; CHECK-NEXT:    addq $32768, %rsi # imm = 0x8000
; CHECK-NEXT:    cmpq %r10, %r11
; CHECK-NEXT:    leaq 1(%r11), %r11
; CHECK-NEXT:    jne .LBB0_9
; CHECK-NEXT:  # %bb.12: # %for.cond.cleanup.clone
; CHECK-NEXT:    vzeroupper
; CHECK-NEXT:    retq
; CHECK-NEXT:  .LBB0_14: # %entry.clone
; CHECK-NEXT:    vxorps %xmm0, %xmm0, %xmm0
; CHECK-NEXT:    retq
entry:
  %cmp26 = icmp sgt i32 %N, 0
  br i1 %cmp26, label %for.body.preheader, label %for.cond.cleanup

for.body.preheader:                               ; preds = %entry
  %0 = zext i32 %N to i64
  %1 = add nsw i64 %0, -1
  br label %loop.39

for.cond.cleanup:                                 ; preds = %afterloop.48, %entry
  %dst_row.0.lcssa = phi double [ 0.000000e+00, %entry ], [ %19, %afterloop.48 ]
  ret double %dst_row.0.lcssa

loop.39:                                          ; preds = %afterloop.48, %for.body.preheader
  %i1.i64.0 = phi i64 [ 0, %for.body.preheader ], [ %nextivloop.39, %afterloop.48 ]
  %t3.0 = phi double [ 0.000000e+00, %for.body.preheader ], [ %19, %afterloop.48 ]
  %2 = trunc i64 %i1.i64.0 to i32
  %3 = xor i32 %2, -1
  %4 = add i32 %3, %N
  %5 = zext i32 %4 to i64
  %6 = getelementptr inbounds i32*, i32** %rowstart, i64 %5
  %gepload = load i32*, i32** %6, align 8, !tbaa !3
  br label %loop.48

loop.48:                                          ; preds = %loop.48, %loop.39
  %t38.0 = phi <16 x double> [ zeroinitializer, %loop.39 ], [ %18, %loop.48 ]
  %i2.i32.0 = phi i32 [ 0, %loop.39 ], [ %nextivloop.48, %loop.48 ]
  %7 = zext i32 %i2.i32.0 to i64
  %8 = getelementptr inbounds i32, i32* %gepload, i64 %7
  %9 = bitcast i32* %8 to <16 x i32>*
  %gepload38 = load <16 x i32>, <16 x i32>* %9, align 4, !tbaa !7
  %10 = zext <16 x i32> %gepload38 to <16 x i64>
  %11 = getelementptr inbounds double, double* %dst, <16 x i64> %10
  %12 = call <16 x double> @llvm.masked.gather.v16f64.v16p0f64(<16 x double*> %11, i32 8, <16 x i1> <i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true, i1 true>, <16 x double> undef), !tbaa !9
  %13 = shl i64 %i1.i64.0, 12
  %14 = add i64 %13, %7
  %15 = getelementptr inbounds double, double* %luval, i64 %14
  %16 = bitcast double* %15 to <16 x double>*
  %gepload39 = load <16 x double>, <16 x double>* %16, align 8, !tbaa !9
  %17 = fmul fast <16 x double> %12, %gepload39
  %18 = fadd fast <16 x double> %17, %t38.0
  %nextivloop.48 = add nuw nsw i32 %i2.i32.0, 16
  %condloop.48 = icmp ult i32 %i2.i32.0, 4080
  br i1 %condloop.48, label %loop.48, label %afterloop.48, !llvm.loop !11

afterloop.48:                                     ; preds = %loop.48
  %19 = call fast double @llvm.vector.reduce.fadd.v16f64(double %t3.0, <16 x double> %18)
  %nextivloop.39 = add nuw nsw i64 %i1.i64.0, 1
  %condloop.39.not = icmp eq i64 %i1.i64.0, %1
  br i1 %condloop.39.not, label %for.cond.cleanup, label %loop.39, !llvm.loop !16
}

; Function Attrs: nofree nosync nounwind readnone willreturn
declare double @llvm.vector.reduce.fadd.v16f64(double, <16 x double>) #1

; Function Attrs: nofree nosync nounwind readonly willreturn
declare <16 x double> @llvm.masked.gather.v16f64.v16p0f64(<16 x double*>, i32 immarg, <16 x i1>, <16 x double>) #2

attributes #0 = { nofree norecurse nosync nounwind readonly uwtable "denormal-fp-math"="preserve-sign,preserve-sign" "denormal-fp-math-f32"="ieee,ieee" "frame-pointer"="none" "loopopt-pipeline"="full" "min-legal-vector-width"="0" "no-infs-fp-math"="true" "no-nans-fp-math"="true" "no-signed-zeros-fp-math"="true" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="alderlake" "target-features"="+adx,+aes,+avx,+avx2,+avxvnni,+bmi,+bmi2,+cldemote,+clflushopt,+clwb,+crc32,+cx16,+cx8,+f16c,+fma,+fsgsbase,+fxsr,+gfni,+hreset,+invpcid,+kl,+lzcnt,+mmx,+movbe,+movdir64b,+movdiri,+pclmul,+pconfig,+pku,+popcnt,+prfchw,+ptwrite,+rdpid,+rdrnd,+rdseed,+sahf,+serialize,+sgx,+sha,+shstk,+sse,+sse2,+sse3,+sse4.1,+sse4.2,+ssse3,+vaes,+vpclmulqdq,+waitpkg,+widekl,+x87,+xsave,+xsavec,+xsaveopt,+xsaves" "unsafe-fp-math"="true" }
attributes #1 = { nofree nosync nounwind readnone willreturn }
attributes #2 = { nofree nosync nounwind readonly willreturn }

!llvm.module.flags = !{!0, !1}
!llvm.ident = !{!2}

!0 = !{i32 1, !"wchar_size", i32 4}
!1 = !{i32 7, !"uwtable", i32 1}
!2 = !{!"Intel(R) oneAPI DPC++/C++ Compiler 2022.1.0 (2022.x.0.YYYYMMDD)"}
!3 = !{!4, !4, i64 0}
!4 = !{!"pointer@_ZTSPj", !5, i64 0}
!5 = !{!"omnipotent char", !6, i64 0}
!6 = !{!"Simple C/C++ TBAA"}
!7 = !{!8, !8, i64 0}
!8 = !{!"int", !5, i64 0}
!9 = !{!10, !10, i64 0}
!10 = !{!"double", !5, i64 0}
!11 = distinct !{!11, !12, !13, !14, !15}
!12 = !{!"llvm.loop.mustprogress"}
!13 = !{!"llvm.loop.unroll.disable"}
!14 = !{!"llvm.loop.vectorize.width", i32 1}
!15 = !{!"llvm.loop.interleave.count", i32 1}
!16 = distinct !{!16, !12, !13}
