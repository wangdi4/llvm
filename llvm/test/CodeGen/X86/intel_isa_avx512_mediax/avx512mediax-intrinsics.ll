; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; REQUIRES: intel_feature_isa_avx512_mediax
; RUN: llc < %s -disable-peephole -mtriple=i686-unknown-unknown -mattr=+avx512mediax --show-mc-encoding | FileCheck %s --check-prefixes=X86
; RUN: llc < %s -disable-peephole -mtriple=x86_64-unknown-unknown -mattr=+avx512mediax --show-mc-encoding | FileCheck %s --check-prefixes=X64

declare <32 x i16> @llvm.x86.avx512.mpsadbw.512(<64 x i8>, <64 x i8>, i32)

define <32 x i16>@test_int_x86_avx512_mask_mpsadbw_512(<64 x i8> %x0, <64 x i8> %x1, <32 x i16> %x3, i32 %x4) {
; X86-LABEL: test_int_x86_avx512_mask_mpsadbw_512:
; X86:       # %bb.0:
; X86-NEXT:    kmovd {{[0-9]+}}(%esp), %k1 # encoding: [0xc4,0xe1,0xf9,0x90,0x4c,0x24,0x04]
; X86-NEXT:    vmpsadbw $2, %zmm1, %zmm0, %zmm2 {%k1} # encoding: [0x62,0xf3,0x7e,0x49,0x42,0xd1,0x02]
; X86-NEXT:    vmpsadbw $3, %zmm1, %zmm0, %zmm3 # encoding: [0x62,0xf3,0x7e,0x48,0x42,0xd9,0x03]
; X86-NEXT:    vmpsadbw $4, %zmm1, %zmm0, %zmm0 # encoding: [0x62,0xf3,0x7e,0x48,0x42,0xc1,0x04]
; X86-NEXT:    vpaddw %zmm3, %zmm2, %zmm2 {%k1} # encoding: [0x62,0xf1,0x6d,0x49,0xfd,0xd3]
; X86-NEXT:    vpaddw %zmm0, %zmm2, %zmm0 # encoding: [0x62,0xf1,0x6d,0x48,0xfd,0xc0]
; X86-NEXT:    retl # encoding: [0xc3]
;
; X64-LABEL: test_int_x86_avx512_mask_mpsadbw_512:
; X64:       # %bb.0:
; X64-NEXT:    kmovd %edi, %k1 # encoding: [0xc5,0xfb,0x92,0xcf]
; X64-NEXT:    vmpsadbw $2, %zmm1, %zmm0, %zmm2 {%k1} # encoding: [0x62,0xf3,0x7e,0x49,0x42,0xd1,0x02]
; X64-NEXT:    vmpsadbw $3, %zmm1, %zmm0, %zmm3 # encoding: [0x62,0xf3,0x7e,0x48,0x42,0xd9,0x03]
; X64-NEXT:    vmpsadbw $4, %zmm1, %zmm0, %zmm0 # encoding: [0x62,0xf3,0x7e,0x48,0x42,0xc1,0x04]
; X64-NEXT:    vpaddw %zmm3, %zmm2, %zmm2 {%k1} # encoding: [0x62,0xf1,0x6d,0x49,0xfd,0xd3]
; X64-NEXT:    vpaddw %zmm0, %zmm2, %zmm0 # encoding: [0x62,0xf1,0x6d,0x48,0xfd,0xc0]
; X64-NEXT:    retq # encoding: [0xc3]
  %1 = call <32 x i16> @llvm.x86.avx512.mpsadbw.512(<64 x i8> %x0, <64 x i8> %x1, i32 2)
  %2 = bitcast i32 %x4 to <32 x i1>
  %3 = select <32 x i1> %2, <32 x i16> %1, <32 x i16> %x3
  %4 = call <32 x i16> @llvm.x86.avx512.mpsadbw.512(<64 x i8> %x0, <64 x i8> %x1, i32 3)
  %5 = bitcast i32 %x4 to <32 x i1>
  %6 = select <32 x i1> %5, <32 x i16> %4, <32 x i16> zeroinitializer
  %7 = call <32 x i16> @llvm.x86.avx512.mpsadbw.512(<64 x i8> %x0, <64 x i8> %x1, i32 4)
  %res3 = add <32 x i16> %3, %6
  %res4 = add <32 x i16> %res3, %7
  ret <32 x i16> %res4
}
