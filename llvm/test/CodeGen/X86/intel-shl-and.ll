; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s -mtriple=x86_64-unknown-unknown | FileCheck %s

; Goal here to combine the scale from the gep with the shl in original code.
; Other optimizations can be enabled in the future to merge the movzwl/movzbl.

define i64 @foo(i64* %arg, i16* %arg1, i32 %arg2) {
; CHECK-LABEL: foo:
; CHECK:       # %bb.0: # %bb
; CHECK-NEXT:    movslq %edx, %rax
; CHECK-NEXT:    movzwl (%rsi,%rax,2), %eax
; CHECK-NEXT:    movzbl %al, %eax
; CHECK-NEXT:    shlq $4, %rax
; CHECK-NEXT:    movq (%rdi,%rax), %rax
; CHECK-NEXT:    retq
bb:
  %tmp = sext i32 %arg2 to i64
  %tmp3 = getelementptr inbounds i16, i16* %arg1, i64 %tmp
  %tmp4 = load i16, i16* %tmp3
  %tmp5 = shl i16 %tmp4, 1
  %tmp6 = and i16 %tmp5, 510
  %tmp7 = zext i16 %tmp6 to i64
  %tmp8 = getelementptr inbounds i64, i64* %arg, i64 %tmp7
  %tmp9 = load i64, i64* %tmp8
  ret i64 %tmp9
}
