; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc -mtriple=x86_64-unknown-linux < %s | FileCheck %s --check-prefix=NO-SPILL
; RUN: llc -mtriple=x86_64-unknown-linux < %s -intel-spill-parms | FileCheck %s --check-prefix=SPILL
; RUN: llc -mtriple=x86_64-unknown-linux < %s -intel-spill-parms -fast-isel=true | FileCheck %s --check-prefix=SPILL

define i32 @foo(i32 %a, float %b, i32 %c, i32* %d) nounwind {
; NO-SPILL-LABEL: foo:
; NO-SPILL:       # %bb.0: # %entry
; NO-SPILL-NEXT:    cvttss2si %xmm0, %eax
; NO-SPILL-NEXT:    imull %edi, %eax
; NO-SPILL-NEXT:    addl %esi, %eax
; NO-SPILL-NEXT:    subl (%rdx), %eax
; NO-SPILL-NEXT:    retq
;
; SPILL-LABEL: foo:
; SPILL:       # %bb.0: # %entry
; SPILL-NEXT:    # kill: def $esi killed $esi def $rsi
; SPILL-NEXT:    # kill: def $edi killed $edi def $rdi
; SPILL-NEXT:    movq %rdi, -{{[0-9]+}}(%rsp)
; SPILL-NEXT:    movq %rsi, -{{[0-9]+}}(%rsp)
; SPILL-NEXT:    movq %rdx, -{{[0-9]+}}(%rsp)
; SPILL-NEXT:    cvttss2si %xmm0, %eax
; SPILL-NEXT:    imull %edi, %eax
; SPILL-NEXT:    addl %esi, %eax
; SPILL-NEXT:    subl (%rdx), %eax
; SPILL-NEXT:    retq
entry:
  %conv = fptosi float %b to i32
  %mul = mul nsw i32 %conv, %a
  %add = add nsw i32 %mul, %c
  %ldd = load i32, i32* %d
  %sub = sub i32 %add, %ldd
  ret i32 %sub
}

define i32 @bar(i32 %a, float %b, i32 %c, i32* %d) nounwind {
; NO-SPILL-LABEL: bar:
; NO-SPILL:       # %bb.0: # %entry
; NO-SPILL-NEXT:    pushq %rax
; NO-SPILL-NEXT:    callq foo@PLT
; NO-SPILL-NEXT:    popq %rcx
; NO-SPILL-NEXT:    retq
;
; SPILL-LABEL: bar:
; SPILL:       # %bb.0: # %entry
; SPILL-NEXT:    subq $24, %rsp
; SPILL-NEXT:    # kill: def $esi killed $esi def $rsi
; SPILL-NEXT:    # kill: def $edi killed $edi def $rdi
; SPILL-NEXT:    movq %rdi, {{[0-9]+}}(%rsp)
; SPILL-NEXT:    movq %rsi, {{[0-9]+}}(%rsp)
; SPILL-NEXT:    movq %rdx, (%rsp)
; SPILL-NEXT:    # kill: def $edi killed $edi killed $rdi
; SPILL-NEXT:    # kill: def $esi killed $esi killed $rsi
; SPILL-NEXT:    callq foo@PLT
; SPILL-NEXT:    addq $24, %rsp
; SPILL-NEXT:    retq
entry:
  %call = call i32 @foo(i32 %a, float %b, i32 %c, i32* %d)
  ret i32 %call
}

define i32 @main(i32 %argc, i8** %argv) nounwind {
; NO-SPILL-LABEL: main:
; NO-SPILL:       # %bb.0: # %entry
; NO-SPILL-NEXT:    xorl %eax, %eax
; NO-SPILL-NEXT:    retq
;
; SPILL-LABEL: main:
; SPILL:       # %bb.0: # %entry
; SPILL-NEXT:    # kill: def $edi killed $edi def $rdi
; SPILL-NEXT:    movq %rdi, -{{[0-9]+}}(%rsp)
; SPILL-NEXT:    movq %rsi, -{{[0-9]+}}(%rsp)
; SPILL-NEXT:    xorl %eax, %eax
; SPILL-NEXT:    retq
entry:
  ret i32 0
}
