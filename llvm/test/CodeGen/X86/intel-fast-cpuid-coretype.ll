; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --check-globals
; RUN: opt --mtriple=x86_64-- --mcpu=alderlake -S --x86-pre-isel-intrinsic-lowering -opaque-pointers --verify < %s | FileCheck %s --check-prefix=ADL
; RUN: opt --mtriple=x86_64-- -S --x86-pre-isel-intrinsic-lowering -opaque-pointers --verify < %s | FileCheck %s --check-prefix=OTHERS

;.
; ADL: @[[__CPU_CORE_TYPE:[a-zA-Z0-9_$"\\.-]+]] = external local_unnamed_addr global [0 x i8]
;.
define void @get_cpuid_coretype() nounwind {
; ADL-LABEL: @get_cpuid_coretype(
; ADL-NEXT:  entry:
; ADL-NEXT:    call void @do_something_before()
; ADL-NEXT:    [[TMP0:%.*]] = call i32 @llvm.x86.rdpid()
; ADL-NEXT:    [[TMP1:%.*]] = and i32 [[TMP0]], 255
; ADL-NEXT:    [[TMP2:%.*]] = getelementptr [0 x i8], ptr @__cpu_core_type, i64 0, i32 [[TMP1]]
; ADL-NEXT:    [[TMP3:%.*]] = load i8, ptr [[TMP2]], align 1
; ADL-NEXT:    [[TMP4:%.*]] = icmp ne i8 [[TMP3]], 0
; ADL-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP7:%.*]], !prof [[PROF0:![0-9]+]]
; ADL:       5:
; ADL-NEXT:    [[TMP6:%.*]] = phi i8 [ [[TMP3]], [[ENTRY:%.*]] ], [ [[TMP8:%.*]], [[TMP7]] ]
; ADL-NEXT:    call void @do_something_after(i8 [[TMP6]])
; ADL-NEXT:    ret void
; ADL:       7:
; ADL-NEXT:    [[TMP8]] = call i8 @__detect_cpu_core_type_1n()
; ADL-NEXT:    br label [[TMP5]]
;
; OTHERS-LABEL: @get_cpuid_coretype(
; OTHERS-NEXT:  entry:
; OTHERS-NEXT:    call void @do_something_before()
; OTHERS-NEXT:    [[TMP0:%.*]] = call { i32, i32, i32, i32 } @llvm.x86.cpuid(i32 26, i32 0)
; OTHERS-NEXT:    [[EAX:%.*]] = extractvalue { i32, i32, i32, i32 } [[TMP0]], 0
; OTHERS-NEXT:    [[TMP1:%.*]] = lshr i32 [[EAX]], 24
; OTHERS-NEXT:    [[TMP2:%.*]] = trunc i32 [[TMP1]] to i8
; OTHERS-NEXT:    call void @do_something_after(i8 [[TMP2]])
; OTHERS-NEXT:    ret void
;
entry:
  call void @do_something_before()
  %0 = call i8 @llvm.x86.intel.fast.cpuid.coretype()
  call void @do_something_after(i8 %0)
  ret void
}

declare i8 @llvm.x86.intel.fast.cpuid.coretype() nounwind
declare void @do_something_before() nounwind
declare void @do_something_after(i8) nounwind
;.
; ADL: attributes #[[ATTR0:[0-9]+]] = { nounwind "target-cpu"="alderlake" }
; ADL: attributes #[[ATTR1:[0-9]+]] = { nounwind }
;.
; OTHERS: attributes #[[ATTR0:[0-9]+]] = { nounwind }
;.
; ADL: [[PROF0]] = !{!"branch_weights", i32 2000, i32 1}
;.
