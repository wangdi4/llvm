; REQUIRES: intel_feature_isa_fp16
; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s -mtriple=x86_64-unkown-unkown -mattr=+avx512bw -mattr=+avx512fp16 -mattr=+avx512vl | FileCheck %s

declare <32 x half> @llvm.x86.avx512fp16.add.ph.512(<32 x half>, <32 x half>, i32)

define <32 x half>@test_int_x86_avx512fp16_add_ph_512(<32 x half> %src, <32 x half> %x1, <32 x half> %x2, i32 %msk, <32 x half>* %ptr) {
; CHECK-LABEL: test_int_x86_avx512fp16_add_ph_512:
; CHECK:       # %bb.0:
; CHECK-NEXT:    kmovd	%edi, %k1
; CHECK-NEXT:    vaddph	%zmm2, %zmm1, %zmm3
; CHECK-NEXT:    vaddph	%zmm2, %zmm1, %zmm0 {%k1}
; CHECK-NEXT:    vaddph	%zmm0, %zmm3, %zmm0
; CHECK-NEXT:    vaddph	%zmm2, %zmm1, %zmm2 {%k1} {z}
; CHECK-NEXT:    vaddph	(%rsi), %zmm1, %zmm1 {%k1} {z}
; CHECK-NEXT:    vaddph	%zmm1, %zmm2, %zmm1
; CHECK-NEXT:    vaddph	%zmm1, %zmm0, %zmm0
; CHECK-NEXT:    retq
  %mask = bitcast i32 %msk to <32 x i1>
  %val = load <32 x half>, <32 x half>* %ptr
  %res0 = call <32 x half> @llvm.x86.avx512fp16.add.ph.512(<32 x half> %x1, <32 x half> %x2, i32 4)
  %res1 = select <32 x i1> %mask, <32 x half> %res0, <32 x half> %src
  %res2 = select <32 x i1> %mask, <32 x half> %res0, <32 x half> zeroinitializer
  %t3 = call <32 x half> @llvm.x86.avx512fp16.add.ph.512(<32 x half> %x1, <32 x half> %val, i32 4)
  %res3 = select <32 x i1> %mask, <32 x half> %t3, <32 x half> zeroinitializer
  %res4  =  fadd <32 x half> %res0 , %res1
  %res5  =  fadd <32 x half> %res2 , %res3
  %res   =  fadd <32 x half> %res4 , %res5
  ret <32 x half> %res
}

define <32 x half>@test_int_x86_avx512fp16_add_ph_512_round(<32 x half> %x1, <32 x half> %x2, <32 x half> %src, i32 %msk, <32 x half>* %ptr) {
; CHECK-LABEL: test_int_x86_avx512fp16_add_ph_512_round:
; CHECK:       # %bb.0:
; CHECK-NEXT:    kmovd %edi, %k1
; CHECK-NEXT:    vaddph {ru-sae}, %zmm1, %zmm0, %zmm2 {%k1}
; CHECK-NEXT:    vmovdqa64 %zmm2, %zmm0
; CHECK-NEXT:    retq
  %mask = bitcast i32 %msk to <32 x i1>
  %t1 = call <32 x half> @llvm.x86.avx512fp16.add.ph.512(<32 x half> %x1, <32 x half> %x2, i32 10)
  %res = select <32 x i1> %mask, <32 x half> %t1, <32 x half> %src
  ret <32 x half> %res
}
