#
# Global setup file for OpenCL CMake
#
cmake_minimum_required(VERSION 2.8.4)
cmake_policy(SET CMP0001 NEW)
cmake_policy(SET CMP0011 OLD)

include( cmake_utils/CMakeFuncs.txt )


# the FindSubversion.cmake module is part of the standard distribution
include(FindSubversion)

# When cross-compiling LLVM; CONFORMANCE_LIST won't be defined!
if( CONFORMANCE_LIST )
string(REPLACE " " ";" CONFORMANCE_LIST ${CONFORMANCE_LIST})
endif( CONFORMANCE_LIST )

if (WIN32)
    include( cmake_utils/CMake_windows_tools.cmake )
elseif( ANDROID )
    include( cmake_utils/CMake_android_tools.cmake )
elseif (APPLE)
    #include( cmake_utils/CMake_apple_tools.cmake )
    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/")
else ()
    include( cmake_utils/CMake_linux_tools.cmake )
endif ()

add_definitions (-DCL_USE_DEPRECATED_OPENCL_1_1_APIS)

FIND_PACKAGE(Boost 1.52.0 REQUIRED)
#PRINT_TOOLS()

#
# Project defs
#
project(OCL)

#
# Project variables:
#  OCL_SOURCE_DIR    - points to the top src directory
#  OCL_BINARY_DIR    - points to the directory outside of OCL_SOURCE_DIR - root of generated files
#

# extract working copy information for all components into variables
option(SVN_REVISIONS "Make package version from svn revision"  ON)
if (SVN_REVISIONS)
    Subversion_WC_INFO(${OCL_SOURCE_DIR} BUILDVER)
else ()
    set( BUILDVER "0" )
endif (SVN_REVISIONS)

message("Current build version is ${BUILDVER_WC_LAST_CHANGED_REV}")

option(INCLUDE_MIC_DEVICE "Include MIC device Into Build"  OFF)

# vars
set( OCL_MAKE_UTILS_DIR ${OCL_SOURCE_DIR}/cmake_utils )

if (WIN32 AND ((${CMAKE_CFG_INTDIR} STREQUAL $(OutDir)) OR (${CMAKE_CFG_INTDIR} STREQUAL $(Configuration))))
    set( INSTALL_SUBDIR ${CMAKE_CFG_INTDIR} )
else ()
    set( INSTALL_SUBDIR ${CMAKE_BUILD_TYPE} )
endif ()

set( OCL_GLOBAL_INCLUDE   ${OCL_SOURCE_DIR}/cl_api )
set( OCL_CLANG_HEADERS   ${OCL_SOURCE_DIR}/backend/clang_headers )

# write a file with the BUILDVERSION define
file(WRITE ${OCL_BINARY_DIR}/buildversion.h.txt "#define BUILDVERSION ${BUILDVER_WC_REVISION}\n#ifndef\ _DEBUG\n#define BUILDVERSIONSTR "\"(Build\ ${BUILDVER_WC_REVISION})"\"\n#else\n#define BUILDVERSIONSTR "\"(Build[DEBUG]\ ${BUILDVER_WC_REVISION})"\"\n#endif")
file(WRITE ${OCL_BINARY_DIR}/version.txt "3.0.${BUILDVER_WC_REVISION}")

#copy the version file to install folder
install(FILES ${OCL_BINARY_DIR}/version.txt DESTINATION ./)

# copy the file to the final header only if the version changes
# reduces needless rebuilds
execute_process(COMMAND ${CMAKE_COMMAND} -E copy_if_different ${OCL_BINARY_DIR}/buildversion.h.txt ${OCL_BINARY_DIR}/buildversion.h)

# paths
include_directories( BEFORE
        utils/cl_logger/export
        utils/cl_sys_utils/export
        externals/tbb/include
        ${OCL_GLOBAL_INCLUDE}
    )

# set OS-dependent source tree elements
if (WIN32)
    set(OS            Win)
    set(IMPLIB_SUBDIR lib)
    set(IMPLIB_PREFIX    )
    set(IMPLIB_SUFFIX .lib)
	set(IMPLIB_STATIC_SUFFIX .lib)
	set(DLL_SUFIX .dll)
elseif (APPLE)
    set(OS Mac)
    set(IMPLIB_SUBDIR bin)
    set(IMPLIB_PREFIX lib)
    set(IMPLIB_SUFFIX .so)
	set(IMPLIB_STATIC_SUFFIX .a)
	set(DLL_SUFIX .so)
else ()
    set(OS Lin)
    set(IMPLIB_SUBDIR bin)
    set(IMPLIB_PREFIX lib)
    set(IMPLIB_SUFFIX .so)
	set(IMPLIB_STATIC_SUFFIX .a)
	set(DLL_SUFIX .so)
endif( )

if (CMAKE_SIZEOF_VOID_P EQUAL 4)
    set(ADDR 32)
else ()
    set(ADDR 64)
endif (CMAKE_SIZEOF_VOID_P EQUAL 4)

# set windows binary suffix 
if (WIN32)
    set (BUILD_PLATFORM ${ADDR})
else (WIN32)
    set (BUILD_PLATFORM "")
endif (WIN32)

set(OCL_SYS_DEPENDENT_SUBDIR        ${OS}${ADDR}_${INSTALL_SUBDIR})
set(OCL_SYS_DEPENDENT_IMPLIB_SUBDIR ${IMPLIB_SUBDIR}/${OCL_SYS_DEPENDENT_SUBDIR})

# END OF set OS-dependent source tree elements

SET_UNICODE_OFF()

set_property( GLOBAL PROPERTY USE_FOLDERS ON )

# Framework IDE Folders Names
set( FRAMEWORK_FOLDER_NAME      Framework )
set( API_FOLDER_NAME            ${FRAMEWORK_FOLDER_NAME}/API )
set( DEVICES_FOLDER_NAME        ${FRAMEWORK_FOLDER_NAME}/Devices )
set( RUNTIME_FOLDER_NAME        ${FRAMEWORK_FOLDER_NAME}/Runtime )
set( UTILS_FOLDER_NAME          ${FRAMEWORK_FOLDER_NAME}/utils )
set( TOOLS_FOLDER_NAME          ${FRAMEWORK_FOLDER_NAME}/Tools )
set( FE_COMPILER_FOLDER_NAME    "${FRAMEWORK_FOLDER_NAME}/Front-end Compiler" )
set( EXTERNAL_FOLDER_NAME       External )

if (APPLE)
	#set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/")
	add_subdirectory( backend )
else(APPLE)
	# externals
	add_subdirectory(externals)

	add_subdirectory( cl_api )
	add_subdirectory( utils )

	# Backend + LLVM + Clang
	add_subdirectory( backend )

	#devices
	add_subdirectory( devices )

	#FE compilers
	add_subdirectory( fe_compilers )

	# Framework
	add_subdirectory( framework )

	# Common Runime
	option(INCLUDE_CMRT "Include Common Runtime into Build"  OFF)
	if (WIN32 AND INCLUDE_CMRT)
    		add_subdirectory ( common_runtime )
	endif(WIN32 AND INCLUDE_CMRT)
	#tools
	if( NOT ANDROID )
  		add_subdirectory ( tools )
	endif( NOT ANDROID )


	#validation
	add_subdirectory( tests )

    #workloads
    add_subdirectory( workloads )
endif(APPLE) 

