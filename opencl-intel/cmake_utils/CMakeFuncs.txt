set (__MAKEFUNCS_INCLUDED__ 1)

#
# Usage
#     FILTER_SOURCES()
#
# Filters HEADER_FILES_1, EXPORT_HEADER_FILES_1 and SOURCE_FILES_1 variables to remove Win or Linux files
# Creates HEADER_FILES, EXPORT_HEADER_FILES and SOURCE_FILES variables
#
macro( FILTER_SOURCES FILER_OUT_REGEXP )
      list(APPEND HEADER_FILES_1 ${EXPORT_HEADER_FILES_1})
	  
      if ((WIN32) AND (NOT FORCE_LINUX))
            foreach(FILE ${HEADER_FILES_1})
                if ( NOT FILE MATCHES _linux AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
                        list(APPEND HEADER_FILES_2 ${FILE})
                endif ( NOT FILE MATCHES _linux AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
            endforeach(FILE)

            foreach(FILE ${SOURCE_FILES_1})
                if ( NOT FILE MATCHES  ^stdafx[.]c.*$|_linux  AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
                        list(APPEND SOURCE_FILES_2 ${FILE})
                endif ( NOT FILE MATCHES  ^stdafx[.]c.*$|_linux  AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
            endforeach(FILE)

            file(GLOB RECOURCE_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} *.rc *.def)
            list(APPEND SOURCE_FILES_2 ${RECOURCE_FILES_1})

        else () # Linux

            foreach(FILE ${HEADER_FILES_1})
                if ( NOT FILE MATCHES ^resource[.]h$|^stdafx[.]h$|_windows|_win32 AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
                        list(APPEND HEADER_FILES_2 ${FILE})
                endif ( NOT FILE MATCHES ^resource[.]h$|^stdafx[.]h$|_windows|_win32 AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
            endforeach(FILE)

            foreach(FILE ${SOURCE_FILES_1})
                if ( NOT FILE MATCHES ^stdafx[.]c.*$|_windows|_win32 AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
                        list(APPEND SOURCE_FILES_2 ${FILE})
                endif ( NOT FILE MATCHES ^stdafx[.]c.*$|_windows|_win32 AND NOT FILE MATCHES ${FILER_OUT_REGEXP})
            endforeach(FILE)

      endif ((WIN32) AND (NOT FORCE_LINUX))

      if (DEFINED HEADER_FILES_2)
          set (HEADER_FILES ${HEADER_FILES_2} PARENT_SCOPE)
      endif (DEFINED HEADER_FILES_2)

      if (DEFINED SOURCE_FILES_2)
          set (SOURCE_FILES ${SOURCE_FILES_2} PARENT_SCOPE)
      endif (DEFINED SOURCE_FILES_2)

      if (DEFINED EXPORT_HEADER_FILES_1)
          set (EXPORT_HEADER_FILES ${EXPORT_HEADER_FILES_1} PARENT_SCOPE)
          include_directories( BEFORE export )
      endif (DEFINED EXPORT_HEADER_FILES_1)

endmacro( FILTER_SOURCES )

#
# Usage
#     FIND_SOURCES( optional FILER_OUT_REGEXP )
#
# Creates HEADER_FILES, EXPORT_HEADER_FILES and SOURCE_FILES variables
# by globbing CMAKE_CURRENT_SOURCE_DIR
#
function ( FIND_SOURCES )
    file(GLOB HEADER_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} *.h *.hpp)
    file(GLOB EXPORT_HEADER_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} export/*.h export/*.hpp)
    file(GLOB SOURCE_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} *.c *.cpp *.cc)

    if (${ARGC} EQUAL 0 )
        set( FILER_OUT_REGEXP "not used regexp" )
    else()
        set( FILER_OUT_REGEXP ${ARGV0} )
    endif (${ARGC} EQUAL  0 )

    FILTER_SOURCES( ${FILER_OUT_REGEXP} )
endfunction ( FIND_SOURCES )

#
# Usage
#     FIND_SOURCES_EX( SOURCE_DIRECTORY optional FILER_OUT_REGEXP )
#
# Creates HEADER_FILES, EXPORT_HEADER_FILES and SOURCE_FILES variables
# by globbing SOURCE_DIRECTORY
#
function ( FIND_SOURCES_EX SOURCE_DIRECTORY )
    file(GLOB HEADER_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} ${SOURCE_DIRECTORY}/*.h ${SOURCE_DIRECTORY}/*.hpp)
    file(GLOB EXPORT_HEADER_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} ${SOURCE_DIRECTORY}/export/*.h ${SOURCE_DIRECTORY}/export/*.hpp)
    file(GLOB SOURCE_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} ${SOURCE_DIRECTORY}/*.c ${SOURCE_DIRECTORY}/*.cpp ${SOURCE_DIRECTORY}/*.cc)

    if (${ARGC} EQUAL 1 )
        set( FILER_OUT_REGEXP "not used regexp" )
    else()
        set( FILER_OUT_REGEXP ${ARGV1} )
    endif (${ARGC} EQUAL  1 )

    FILTER_SOURCES( ${FILER_OUT_REGEXP} )
endfunction ( FIND_SOURCES_EX )

#
# Usage
#     FIND_SOURCES_IN_FOLDER( optional FOLDER_ARG optional FILER_OUT_REGEXP )
#
# Creates HEADER_FILES, EXPORT_HEADER_FILES and SOURCE_FILES variables
# by globbing CMAKE_CURRENT_SOURCE_DIR
#
function ( FIND_SOURCES_IN_FOLDER )
    if (${ARGC} EQUAL 0 )
        set( FOLDER_ARG "not used folder" )
    else()
        set( FOLDER_ARG ${ARGV0} )
    endif (${ARGC} EQUAL  0 )
    
    file(GLOB HEADER_FILES_1 ${FOLDER_ARG}/*.h ${FOLDER_ARG}/*.hpp)
    file(GLOB EXPORT_HEADER_FILES_1 ${FOLDER_ARG}/export/*.h ${FOLDER_ARG}/export/*.hpp)
    file(GLOB SOURCE_FILES_1 ${FOLDER_ARG}/*.c ${FOLDER_ARG}/*.cpp ${FOLDER_ARG}/*.cc)

    if (${ARGC} EQUAL 1 OR ${ARGC} EQUAL 0)
        set( FILER_OUT_REGEXP "not used regexp" )
    else()
        set( FILER_OUT_REGEXP ${ARGV1} )
    endif (${ARGC} EQUAL  1 OR ${ARGC} EQUAL 0 )

    FILTER_SOURCES( ${FILER_OUT_REGEXP} )
endfunction ( FIND_SOURCES_IN_FOLDER )

#
# Usage
#     FIND_SOURCES_RECURSE( optional FILER_OUT_REGEXP )
#
# Creates HEADER_FILES and SOURCE_FILES variables
# by globbing CMAKE_CURRENT_SOURCE_DIR recursively
#
function ( FIND_SOURCES_RECURSE )
    file(GLOB_RECURSE HEADER_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} *.h *.hpp)
    file(GLOB_RECURSE SOURCE_FILES_1 RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} *.c *.cpp *.cc)

    if (${ARGC} EQUAL  0 )
        set( FILER_OUT_REGEXP "not used regexp" )
    else()
        set( FILER_OUT_REGEXP ${ARGV0} )
    endif(${ARGC} EQUAL  0 )

    FILTER_SOURCES( ${FILER_OUT_REGEXP} )
endfunction ( FIND_SOURCES_RECURSE )


#
# Usage
#     CALCULATE_TARGET_SOURCES()
#
# Uses HEADER_FILES, EXPORT_HEADER_FILES and SOURCE_FILES variables and creates TARGET_SOURCES
#
function ( CALCULATE_TARGET_SOURCES )
    if ((WIN32) AND (NOT FORCE_LINUX))
        set( TARGET_SOURCES_1 ${HEADER_FILES} ${SOURCE_FILES} )

        source_group( "Header Files" FILES ${HEADER_FILES} )
        source_group( "Source Files" FILES ${SOURCE_FILES} )

        foreach ( FILE ${HEADER_FILES} ${SOURCE_FILES} )
            if ( FILE MATCHES ^.*[.]rc$|^resource[.]h$ )
                source_group( "Resource Files" FILES ${FILE} )
            elseif ( FILE MATCHES ^stdafx[.]|[.]def$ )
                source_group( "Extra Files" FILES ${FILE} )
            elseif ( FILE MATCHES "^(.+)/[^/]+$" )
                source_group( ${CMAKE_MATCH_1} FILES ${FILE} )
            endif ( FILE MATCHES ^.*[.]rc$|^resource[.]h$ )
        endforeach (FILE)

        if (DEFINED EXPORT_HEADER_FILES)
            source_group( "Export Header Files" FILES ${EXPORT_HEADER_FILES} )
        endif (DEFINED EXPORT_HEADER_FILES)

    else ()
        set( TARGET_SOURCES_1 ${SOURCE_FILES} )
    endif ((WIN32) AND (NOT FORCE_LINUX))

  if (DEFINED TARGET_SOURCES_1)
      set (TARGET_SOURCES ${TARGET_SOURCES_1} PARENT_SCOPE)
  endif (DEFINED TARGET_SOURCES_1)

endfunction ( CALCULATE_TARGET_SOURCES )

#
# Usage
#     SET_LINUX_EXPORTS_FILE( TARGET FILE_NAME )
#
function ( SET_LINUX_EXPORTS_FILE TARGET FILE_NAME )
    if ((NOT WIN32) OR (FORCE_LINUX))
        get_target_property( SOURCE_FILES ${TARGET_NAME} SOURCES )
        list( GET SOURCE_FILES 0 FIRST_SOURCE )
        set_source_files_properties( ${FIRST_SOURCE} PROPERTIES OBJECT_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/${FILE_NAME} )
        set_property( TARGET ${TARGET_NAME} APPEND PROPERTY
                        LINK_FLAGS "-Wl,-Bsymbolic -Wl,--version-script=${CMAKE_CURRENT_SOURCE_DIR}/${FILE_NAME}" )
    endif ((NOT WIN32) OR (FORCE_LINUX))
endfunction ( SET_LINUX_EXPORTS_FILE )

#
# Usage
#     CREATE_ASM_RULES( <ADD_TO_SOURCES_LIST_VAR> ...<asm-files-list>...)
#
# Creates ADD_TO_SOURCES_LIST_VAR that should be added to the source files list
#
macro( CREATE_ASM_RULES ADD_TO_SOURCES_LIST_VAR )

    if (${ARGC} GREATER  1)
        foreach( FILE ${ARGN} )
            get_filename_component( FILE_NAME ${FILE} NAME_WE )
            set( BIN_DIR  ${CMAKE_CURRENT_BINARY_DIR}/${INSTALL_SUBDIR} )
            set( OBJ_FILE ${BIN_DIR}/${FILE_NAME}${CMAKE_C_OUTPUT_EXTENSION} )
            set( SRC_FILE ${CMAKE_CURRENT_SOURCE_DIR}/${FILE} )

            if (CMAKE_ASM_OUTPUT_NAME_FLAG)
                set( OBJ_OUTPUT_NAME_FLAG ${CMAKE_ASM_OUTPUT_NAME_FLAG} ${FILE_NAME}${CMAKE_C_OUTPUT_EXTENSION} )
            endif (CMAKE_ASM_OUTPUT_NAME_FLAG)

            add_custom_command(OUTPUT ${OBJ_FILE}
                               COMMAND ${CMAKE_COMMAND} -E make_directory ${BIN_DIR}
                               COMMAND ${CMAKE_COMMAND} -E chdir ${BIN_DIR}
                                       ${CMAKE_ASM_COMPILER} ${CMAKE_ASM_FLAGS}
                                                             ${CMAKE_ASM_INCLUDE_DIR_FLAG} ${CMAKE_CURRENT_SOURCE_DIR}
                                                             ${OBJ_OUTPUT_NAME_FLAG}
                                                             ${SRC_FILE}
                               MAIN_DEPENDENCY ${SRC_FILE}
                               VERBATIM
                               )

            list(APPEND OBJ_FILES ${OBJ_FILE})
            list(APPEND SRC_FILES ${SRC_FILE})
        endforeach( FILE )
    endif (${ARGC} GREATER 1)

    if (DEFINED OBJ_FILES)
        set (${ADD_TO_SOURCES_LIST_VAR} ${SRC_FILES} ${OBJ_FILES})
        set_source_files_properties( ${OBJ_FILES} PROPERTIES GENERATED TRUE EXTERNAL_OBJECT TRUE )
    endif(DEFINED OBJ_FILES)

endmacro( CREATE_ASM_RULES )

#
# Usage: SET_UNICODE_ON()
#        SET_UNICODE_OFF()
#
macro( SET_UNICODE_ON )
    add_definitions( -D_UNICODE -DUNICODE )
endmacro( SET_UNICODE_ON )

macro( SET_UNICODE_OFF )
    remove_definitions( -D_UNICODE -DUNICODE )
endmacro( SET_UNICODE_OFF )

#
# Usage: PRINT_TOOLS()
#
function( PRINT_TOOLS )
    message(STATUS CMAKE_C_FLAGS " - " ${CMAKE_C_FLAGS})
    message(STATUS CMAKE_C_FLAGS_DEBUG " - "  ${CMAKE_C_FLAGS_DEBUG})
    message(STATUS CMAKE_C_FLAGS_RELEASE " - "  ${CMAKE_C_FLAGS_RELEASE})
    message(STATUS CMAKE_CXX_FLAGS " - "  ${CMAKE_CXX_FLAGS})
    message(STATUS CMAKE_CXX_FLAGS_DEBUG " - "  ${CMAKE_CXX_FLAGS_DEBUG})
    message(STATUS CMAKE_CXX_FLAGS_RELEASE " - "  ${CMAKE_CXX_FLAGS_RELEASE})
    message(STATUS CMAKE_EXE_LINKER_FLAGS " - "  ${CMAKE_EXE_LINKER_FLAGS})
    message(STATUS CMAKE_EXE_LINKER_FLAGS_DEBUG " - "  ${CMAKE_EXE_LINKER_FLAGS_DEBUG})
    message(STATUS CMAKE_EXE_LINKER_FLAGS_RELEASE " - "  ${CMAKE_EXE_LINKER_FLAGS_RELEASE})
    message(STATUS CMAKE_SHARED_LINKER_FLAGS " - "  ${CMAKE_SHARED_LINKER_FLAGS})
    message(STATUS CMAKE_SHARED_LINKER_FLAGS_DEBUG " - "  ${CMAKE_SHARED_LINKER_FLAGS_DEBUG})
    message(STATUS CMAKE_SHARED_LINKER_FLAGS_RELEASE " - "  ${CMAKE_SHARED_LINKER_FLAGS_RELEASE})
endfunction( PRINT_TOOLS )

#
# Removes the given path from the PATH environment 
# Usage: remove_path( PATH )
#
function( remove_path PATHARG )
    foreach(PATH $ENV{PATH})
        string(TOUPPER ${PATHARG} UPATHARG)
        string(TOUPPER ${PATH} UPATH)
        if ( NOT "${UPATH}" STREQUAL "" )
            string(COMPARE NOTEQUAL ${UPATH} ${UPATHARG} PATH_NOTFOUND)
            if( PATH_NOTFOUND)
                set( NEW_PATH ${NEW_PATH} ${PATH})
            endif()
        endif()
    endforeach(PATH)
    set(ENV{PATH} "${NEW_PATH}")
endfunction( remove_path )


#
# Replaces a compiler option or switch `old' in `var' by `new'.
# If `old' is not in `var', appends `new' to `var'.
# If the option already is on the variable, don't add it
# Usage: llvm_replace_compiler_option(CMAKE_CXX_FLAGS_RELEASE "-O3" "-O2")
#
function(ocl_replace_compiler_option var old new)
  if( "${${var}}" MATCHES "(^| )${new}($| )" )
    set(n "")
  else()
    set(n "${new}")
  endif()
  if( "${${var}}" MATCHES "(^| )${old}($| )" )
    string( REGEX REPLACE "(^| )${old}($| )" " ${n} " ${var} "${${var}}" )
  else()
    set( ${var} "${${var}} ${n}" )
  endif()
  set( ${var} "${${var}}" PARENT_SCOPE )
endfunction(ocl_replace_compiler_option)

#
# Replaces compiler options to dynamic linking
#
function(ocl_replace_compiler_option_to_dynamic)
    ocl_replace_compiler_option(CMAKE_C_FLAGS_RELEASE "/MT" "/MD")
    ocl_replace_compiler_option(CMAKE_C_FLAGS_DEBUG "/MTd" "/MDd")
    ocl_replace_compiler_option(CMAKE_CXX_FLAGS_RELEASE "/MT" "/MD")
    ocl_replace_compiler_option(CMAKE_CXX_FLAGS_DEBUG "/MTd" "/MDd")
    ocl_replace_compiler_option(CMAKE_EXE_LINKER_FLAGS_RELEASE "/NODEFAULTLIB:LIBCMTD" "")
    ocl_replace_compiler_option(CMAKE_EXE_LINKER_FLAGS_RELEASE "/NODEFAULTLIB:LIBCPMTD" "")
    ocl_replace_compiler_option(CMAKE_EXE_LINKER_FLAGS_DEBUG "/NODEFAULTLIB:LIBCMT" "")
    ocl_replace_compiler_option(CMAKE_EXE_LINKER_FLAGS_DEBUG "/NODEFAULTLIB:LIBCPMT" "")
    
    set(CMAKE_C_FLAGS_RELEASE ${CMAKE_C_FLAGS_RELEASE} PARENT_SCOPE)
    set(CMAKE_C_FLAGS_DEBUG ${CMAKE_C_FLAGS_DEBUG} PARENT_SCOPE)
    set(CMAKE_CXX_FLAGS_RELEASE ${CMAKE_CXX_FLAGS_RELEASE} PARENT_SCOPE)
    set(CMAKE_CXX_FLAGS_DEBUG ${CMAKE_CXX_FLAGS_DEBUG} PARENT_SCOPE)
    set(CMAKE_EXE_LINKER_FLAGS_RELEASE ${CMAKE_EXE_LINKER_FLAGS_RELEASE} PARENT_SCOPE)
    set(CMAKE_EXE_LINKER_FLAGS_DEBUG ${CMAKE_EXE_LINKER_FLAGS_DEBUG} PARENT_SCOPE)
endfunction(ocl_replace_compiler_option_to_dynamic)
