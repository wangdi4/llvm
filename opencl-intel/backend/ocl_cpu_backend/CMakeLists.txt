#
# INTEL CONFIDENTIAL
#
# Copyright (C) 2021-2022 Intel Corporation
#
# This software and the related documents are Intel copyrighted materials, and
# your use of them is governed by the express license under which they were
# provided to you ("License"). Unless the License provides otherwise, you may
# not use, modify, copy, publish, distribute, disclose or transmit this software
# or the related documents without Intel's prior written permission.
#
# This software and the related documents are provided as is, with no express or
# implied warranties, other than those that are expressly stated in the License.
#

set(TARGET_NAME OclCpuBackEnd)

add_subdirectory(emutls)

if(BUILD_X64)
  set(PLATFORM 64)
else()
  set(PLATFORM 32)
endif()

set(OCL_CPU_BACKEND_DIR ${CMAKE_CURRENT_SOURCE_DIR})

#
# Settings for Linux compilation
#
if(NOT WIN32)
  # Compiler switches that CANNOT be modified during makefile generation
  set(ADD_COMMON_C_FLAGS "-msse3 -mssse3 -fPIC -fdiagnostics-show-option")

  set(ADD_C_FLAGS "${ADD_COMMON_C_FLAGS} -std=gnu99")
  set(ADD_CXX_FLAGS "${ADD_COMMON_C_FLAGS}")

  set(ADD_C_FLAGS_DEBUG "-O0 -ggdb -D _DEBUG")
  set(ADD_C_FLAGS_RELEASE "-O2")

  # Compiler switches that CAN be modified during makefile generation and
  # configuration-independent

  find_package(Threads)

  # C switches
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS}         ${ADD_C_FLAGS}")
  set(CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_DEBUG}   ${ADD_C_FLAGS_DEBUG}")
  set(CMAKE_C_FLAGS_RELEASE "${CMAKE_C_FLAGS_RELEASE} ${ADD_C_FLAGS_RELEASE}")

  # C++ switches
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}         ${ADD_CXX_FLAGS}")
  set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG}   ${ADD_C_FLAGS_DEBUG}")
  set(CMAKE_CXX_FLAGS_RELEASE
      "${CMAKE_CXX_FLAGS_RELEASE} ${ADD_C_FLAGS_RELEASE}")
endif(NOT WIN32)

use_rtti(FALSE)

# This macro is to provide a default path for ocl backend to find shared builtin
# libraries.
add_definitions(-DDEFAULT_OCL_LIBRARY_DIR="${OCL_OUTPUT_LIBRARY_DIR}")

# Create target project
set(OCL_CPU_BACKEND_INCLUDE_FILES
    # Interface
    IAbstractBackendFactory.h
    IDynamicFunctionsResolver.h
    IBlockToKernelMapper.h
    ICompilerConfig.h
    BackendConfiguration.h
    BitCodeContainer.h
    BlockLiteral.h
    BuiltinModules.h
    BuiltinModuleManager.h
    CPUBlockToKernelMapper.h
    CPUBuiltinLibrary.h
    CPUCompileService.h
    CPUCompiler.h
    CPUDeviceBackendFactory.h
    CPUExecutionService.h
    CPUJITContainer.h
    CPUKernel.h
    CPUProgram.h
    CPUProgramBuilder.h
    CPUSerializationService.h
    ObjectCodeCache.h
    ObjectCodeContainer.h
    CompileService.h
    Compiler.h
    CompilerConfig.h
    ExecutionService.h
    FPGAEmuBuiltinLibrary.h
    ImageCallbackLibrary.h
    ImageCallbackManager.h
    ImageCallbackServices.h
    Kernel.h
    KernelProperties.h
    LibraryProgramManager.h
    Program.h
    ProgramBuilder.h
    RuntimeService.h
    Serializer.h
    ServiceFactory.h
    StaticObjectLoader.h
    debuggingservicewrapper.h
    opencl_printf_ext.h
    ${OCL_CPU_BACKEND_DIR}/export/plugin_interface.h
    ${BACKEND_ROOT_DIR}/ocl_cpu_debugging/export/icldebuggingservice.h
    ${OCL_SOURCE_DIR}/externals/itt/include/jitprofiling.h
    AsmCompiler.h)

set(OCL_CPU_BACKEND_SOURCE_FILES
    BackendConfiguration.cpp
    BitCodeContainer.cpp
    BuiltinModules.cpp
    BuiltinModuleManager.cpp
    CPUBlockToKernelMapper.cpp
    CPUBuiltinLibrary.cpp
    CPUCompileService.cpp
    CPUCompiler.cpp
    CPUDeviceBackendFactory.cpp
    CPUExecutionService.cpp
    CPUJITContainer.cpp
    CPUKernel.cpp
    CPUProgram.cpp
    CPUProgramBuilder.cpp
    CompileService.cpp
    Compiler.cpp
    CompilerConfig.cpp
    ExecutionService.cpp
    FPGAEmuBuiltinLibrary.cpp
    ImageCallbackLibrary.cpp
    ImageCallbackManager.cpp
    ImageCallbackServices.cpp
    Kernel.cpp
    KernelProperties.cpp
    LibraryProgramManager.cpp
    Program.cpp
    Serializer.cpp
    ObjectCodeCache.cpp
    CPUSerializationService.cpp
    ObjectCodeContainer.cpp
    ProgramBuilder.cpp
    ServiceFactory.cpp
    cpu_builtin_functions.cpp
    debuggingservicewrapper.cpp
    dllmain.cpp
    ocl_debug_builtins.cpp
    opencl20_ext_execution.cpp
    opencl_cpu_printf_ext.cpp
    opencl_printf_ext.cpp
    opencl_task_sequence.cpp
    AsmCompiler.cpp)
if(WIN32)
  list(APPEND OCL_CPU_BACKEND_INCLUDE_FILES LLDJITBuilder.h LLDJIT.h)
  list(APPEND OCL_CPU_BACKEND_SOURCE_FILES LLDJITBuilder.cpp LLDJIT.cpp
       ihc_thread_win32.cpp)
else(WIN32)
  list(APPEND OCL_CPU_BACKEND_SOURCE_FILES ihc_thread_linux.cpp)
endif(WIN32)

# Add include directories
set(INCLUDE_DIRS
    ${LLVM_INCLUDE_DIRS}
    ${CL_API_HEADERS}
    ${OCL_CPU_BACKEND_DIR}
    ${OCL_SOURCE_DIR}/utils/cache_binary_handler
    ${OCL_SOURCE_DIR}/utils/cl_sys_utils/export
    ${OCL_SOURCE_DIR}/utils/CLElfLib
    ${BACKEND_ROOT_DIR}/ocl_cpu_debugging/export
    ${BACKEND_ROOT_DIR}/arch_headers
    ${BACKEND_ROOT_DIR}/vectorizer/Utils
    ${BACKEND_ROOT_DIR}/optimizer
    ${BACKEND_ROOT_DIR}/plugin_manager
    ${BACKEND_ROOT_DIR}/dynamic_lib
    ${BACKEND_ROOT_DIR}/metadata_api
    ${BACKEND_ROOT_DIR}/utils/objdump
    ${CMAKE_BINARY_DIR}/include)

if(WIN32)
  list(APPEND INCLUDE_DIRS ${LLVM_MAIN_SRC_DIR}/../lld/include)
endif(WIN32)

# Create ocl backend lib
add_opencl_library(
  ${TARGET_NAME}
  STATIC
  ${OCL_CPU_BACKEND_INCLUDE_FILES}
  ${OCL_CPU_BACKEND_SOURCE_FILES}
  ${ASM_ADD_TO_SOURCES_LIST}
  INCLUDE_DIRS
  ${INCLUDE_DIRS})

add_dependencies(${TARGET_NAME} intrinsics_gen)

set(CMAKE_CXX_FLAGS_DEBUG "-DOCL_DEV_BACKEND_PLUGINS ${CMAKE_CXX_FLAGS_DEBUG}")

add_definitions(-DOclCpuBackEnd_EXPORTS)
add_definitions(-DOCL_OUTPUT_EXTENSION="${OCL_OUTPUT_EXTENSION}")
add_definitions(
  -DOCL_PRECOMPILED_OUTPUT_EXTENSION="${OCL_PRECOMPILED_OUTPUT_EXTENSION}")
add_definitions(-DOCL_LIBRARY_TARGET_NAME="${OCL_LIBRARY_TARGET_NAME}")

if(ENABLE_SDE)
  message(STATUS "-- Enabling SDE version ... ")
  add_definitions(-DENABLE_SDE)
endif(ENABLE_SDE)

set_target_properties(${TARGET_NAME} PROPERTIES FOLDER ${BACKEND_FOLDER_NAME})
set_target_properties(${TARGET_NAME_EMU} PROPERTIES FOLDER
                                                    ${BACKEND_FOLDER_NAME})
