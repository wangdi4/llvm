# -*- Python -*-

import os

import lit.formats
import lit.util

# Configuration file for the 'lit' test runner.

# name: The name of this test suite.
config.name = 'OCLRTUnitTests'

# Subdirectories where lit will search for test executables
unittest_subdirs = [
    'backend_test_type',
    'cpu_device_test_type',
    'framework_test_type',
    'FrontendDriver_test_type',
    'task_executor_test_type',
    'tbb_native_test_type',
    'name_mangling_test_type',
    'metadata_api_test_type',
    'subgroup_test_type',
    'bi_test_type',
    'fpga_test_type'
]

config.run_tests_in_isolation = True

# FIXME this attribute should be removed.
# Shutdown failure is most likely due to exception thrown from TBB dll. We need
# to refine and restore many shutdown code, including terminating TBB, which
# were commented out.
if config.operating_system == 'Windows':
    config.opencl_report_shutdown_failure = False

test_subdirs = getattr(config, 'test_subdirs', unittest_subdirs)

# testFormat: The test format to use to interpret tests.
cmake_build_type = getattr(config, 'cmake_build_type', "Debug")
config.test_format = lit.formats.GoogleTest(';'.join(test_subdirs), 'test_type')

# test_source_root: The root path where tests are located.
# test_exec_root: The root path where tests should be run.
opencl_tests_binary_dir = getattr(config, 'opencl_tests_binary_dir', None)
if opencl_tests_binary_dir is not None:
    config.test_exec_root = opencl_tests_binary_dir
    config.test_source_root = config.test_exec_root

# Check that the object root is known.
if config.test_exec_root is None:
    # Otherwise, we haven't loaded the site specific configuration (the user is
    # probably trying to run on a test file directly, and either the site
    # configuration hasn't been created by the build system, or we are in an
    # out-of-tree build situation).

    # Check for 'be_site_config' user parameter, and use that if available.
    site_cfg = lit_config.params.get('rt_lit_site_config', None)
    if site_cfg and os.path.exists(site_cfg):
        lit_config.load_config(config, site_cfg)
        raise SystemExit
    else:
        lit_config.fatal('Unable to find lit.site.cfg!')

# path to OpenCL runtime binaries and libraries
opencl_binary_dir = getattr(config, 'opencl_binary_dir', None)
if opencl_binary_dir is None:
    lit_config.fatal('opencl_binary_dir is not set!')

opencl_library_dir = getattr(config, 'opencl_library_dir', None)
if opencl_library_dir is None:
    lit_config.fatal('opencl_library_dir is not set!')

tbb_library_dir = getattr(config, 'tbb_library_dir', None)
if tbb_library_dir is None:
    lit_config.fatal('tbb_library_dir is not set!')

# path to clang profile lib
clang_lib_dir = getattr(config, 'clang_lib_dir', None)
if clang_lib_dir is None:
    lit_config.fatal('clang_lib_dir is not set!')

# Add opencl_binary_dir to the PATH env. variable
if config.operating_system == 'Windows':
    path_var = 'PATH'
    # It's used to load TBB library from full path on Window
    config.environment['TBB_DLL_PATH'] = tbb_library_dir
else:
    path_var = 'LD_LIBRARY_PATH'

paths = os.path.pathsep.join((opencl_binary_dir, opencl_library_dir, tbb_library_dir))

# Add libcommon_clang library to paths:
if config.operating_system == 'Windows':
    paths = os.path.pathsep.join((paths,
        os.path.join(config.llvm_binary_dir, "bin")))
else:
    paths = os.path.pathsep.join((paths, config.llvm_lib_dir))

if path_var in config.environment:
    paths = os.path.pathsep.join((paths, config.environment[path_var]))
config.environment[path_var] = paths

# Add clang profile lib to the CL_CONFIG_FORCE_PROFILE_LIB_PATH env
if config.operating_system == 'Windows':
    config.environment['CL_CONFIG_FORCE_PROFILE_LIB_PATH'] = os.path.join(
        clang_lib_dir, 'clang_rt.profile-x86_64.lib')
else:
    config.environment['CL_CONFIG_FORCE_PROFILE_LIB_PATH'] = os.path.join(
        clang_lib_dir, 'libclang_rt.profile.a')

# Propagate 'ForceOCLCPUVersion' through the environment.
if 'ForceOCLCPUVersion' in os.environ:
    config.environment['ForceOCLCPUVersion'] = os.environ['ForceOCLCPUVersion']

