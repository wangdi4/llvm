# Basics
CC		= icpc
CPP     = icc
LD		= icc
CXX     = icc

SHOCROOT=../../..

MICROOT=$(SHOCROOT)/bin/Serial/knf

BINDIR=$(SHOCROOT)/bin/Serial/knf

COMMON_DIR=$(SHOCROOT)/src/common

KNF_COMMON=$(SHOCROOT)/src/knf/common

VPATH=$(KNF_COMMON):$(COMMON_DIR)

COMMON_SHOC_OBJS = main.o \
			 Option.o \
			 OptionParser.o \
			 Timer.o \
			 ResultDatabase.o \
                         ProgressBar.o

COMMON_OBJS=	         InvalidArgValue.o\
			 CommonKNFStencilFactory.o\
			 KNFStencilKernel.o\
			 KNFStencilFactory.o\
			 KNFStencil.o

BENCH_OBJS = Stencil2Dmain.o

BENCHMARKPROG = $(patsubst %.o,$(BINDIR)/%,$(BENCH_OBJS))

# MKL paths
MKLROOT=/opt/intel/composerxe_mic/mkl
KNF_MKL_LIB_PATH=/opt/intel/composerxe_mic/mkl/lib/mic

# Flags to include KNF MKL library
KNF_MKL_LIBS=-lmkl_core

CFLAGS          = -vec-report2 -parallel -g -O3 -I/opt/intel/composerxe_mic/compiler/include/mic\
		-openmp -intel-extensions  -I$(MKLROOT)/include -I$(KNF_COMMON) -I$(COMMON_DIR)\
		-I$(SHOCROOT)/config -opt-report-phase:offload -openmp-report -DLROWS=16 -DLCOLS=16

LDFLAGS = -vec-report2 -parallel -g -O3  \
	-L$(MKLROOT)/lib/intel64 -Wl,--start-group -openmp -lmkl_intel_lp64 -lmkl_intel_thread -lmkl_core -Wl,--end-group

%.o: %.cpp
	$(CC) -c $< $(CFLAGS) $(CXXFLAGS)

$(BINDIR)/%: %.o 
	$(CC) -o $@ $(CFLAGS) $(CXXFLAGS) $(LDFLAGS) $(COMMON_SHOC_OBJS) $(COMMON_OBJS) $< $(LIBS) 

all : $(BENCHMARKPROG)

$(BENCHMARKPROG) : $(COMMON_OBJS) $(COMMON_SHOC_OBJS)

clean :
	rm *.o *.out *.xnlog
	rm ./bin/*.o
	rm ./bin/*.out

# individual targets

stencil2d : $(BINDIR)/Stencil2D

$(BINDIR)/Stencil2D : $(COMMON_OBJS)

