# UNSUPPORTED: !linux

# Test for checking that LLD links GNU LTO objects.
# This test case handles when linking with archives that have GNU LTO members.

# Copy the files into the temporary directory, this is to prevent multiple
# processes accessing the same files when running the test system in parallel.
# RUN: cp %S/Inputs/driver.cpp driver_test_4.cpp
# RUN: cp %S/Inputs/foo.cpp foo_test_4.cpp
# RUN: cp %S/Inputs/bar.cpp bar_test_4.cpp
# RUN: cp %S/Inputs/baz.cpp baz_test_4.cpp

# Compile with clang++ and LTO
# RUN: clang++ -c -flto driver_test_4.cpp
# RUN: clang++ -c -flto foo_test_4.cpp

# Compile with G++ and LTO
# RUN: g++ -c -flto bar_test_4.cpp
# RUN: g++ -c -flto baz_test_4.cpp

# Create archive, call gcc-ar since it passes the LTO plugin to AR
# RUN: gcc-ar rus arch_test_4.a bar_test_4.o baz_test_4.o

# Link
# RUN: clang++ -fuse-ld=lld driver_test_4.o foo_test_4.o arch_test_4.a -o gnu_lto_test_4 > %t_out.txt 2>&1
# RUN: cat %t_out.txt | FileCheck -check-prefix=CHECKLINK %s -allow-empty

# Check that the files were linked correctly
CHECKLINK-NOT: error: undefined symbol: bar
CHECKLINK-NOT: error: undefined symbol: baz
CHECKLINK: GNU LTO files found in the command line.

# Check that the executable runs correctly
# RUN: ./gnu_lto_test_4 | FileCheck -check-prefix=CHECKRUN4 %s
CHECKRUN4: FOO: 1
CHECKRUN4: BAR: 2
CHECKRUN4: BAZ: 3

# RUN: rm driver_test_4.o foo_test_4.o bar_test_4.o baz_test_4.o
# RUN: rm gnu_lto_test_4
# RUN: rm arch_test_4.a
